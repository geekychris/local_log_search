<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Log Search</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîç</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 1.5rem;
            font-weight: 500;
        }
        .nav-links {
            display: flex;
            gap: 1rem;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .nav-links a:hover {
            background: rgba(255,255,255,0.1);
        }
        .nav-links a.active {
            background: rgba(255,255,255,0.2);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: #2c3e50;
        }
        .two-col {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 1.5rem;
        }
        @media (max-width: 1024px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }
        .form-group {
            margin-bottom: 1rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }
        input[type="text"], input[type="date"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        input[type="text"]:focus, input[type="date"]:focus {
            outline: none;
            border-color: #3498db;
        }
        .date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: #2980b9;
        }
        button:active {
            background: #21618c;
        }
        button.secondary {
            background: #95a5a6;
        }
        button.secondary:hover {
            background: #7f8c8d;
        }
        button.share {
            background: #16a085;
        }
        button.share:hover {
            background: #138d75;
        }
        .button-group {
            display: flex;
            gap: 0.5rem;
        }
        .results {
            margin-top: 1.5rem;
        }
        .result-item {
            background: #f8f9fa;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }
        .result-meta {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        .result-text {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            color: #2c3e50;
            word-wrap: break-word;
        }
        .result-fields {
            margin-top: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .field-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .field-tag:hover {
            background: #1976d2;
            color: white;
            transform: translateY(-1px);
        }
        .field-tag-inline {
            color: #1976d2;
            font-weight: 500;
            cursor: pointer;
            padding: 0 2px;
            border-radius: 2px;
            transition: all 0.2s;
        }
        .field-tag-inline:hover {
            background: #e3f2fd;
            text-decoration: underline;
        }
        .bucket-config {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            margin-top: 0.5rem;
        }
        .bucket-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .bucket-config-content {
            margin-top: 1rem;
        }
        .bucket-field {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .bucket-field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .bucket-field-name {
            font-weight: 500;
            color: #2c3e50;
        }
        .bucket-ranges {
            font-size: 0.875rem;
            color: #666;
            font-family: 'Monaco', 'Courier New', monospace;
        }
        .remove-bucket-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .remove-bucket-btn:hover {
            background: #c0392b;
        }
        .facet-gear {
            margin-left: 0.5rem;
            color: #95a5a6;
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.2s;
        }
        .facet-gear:hover {
            color: #3498db;
        }
        .add-bucket-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .add-bucket-controls input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .add-bucket-controls button {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        .sidebar {
            position: sticky;
            top: 2rem;
        }
        .history-item {
            background: #f8f9fa;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .share-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .share-modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .share-modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .share-modal-close:hover,
        .share-modal-close:focus {
            color: #000;
        }
        .share-option {
            margin: 1rem 0;
        }
        .share-option label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        .share-code {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
            word-break: break-all;
            white-space: pre-wrap;
            border: 1px solid #ddd;
            position: relative;
        }
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .copy-btn:hover {
            background: #2980b9;
        }
        .time-picker-btn {
            background: #16a085;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .time-picker-btn:hover {
            background: #138d75;
        }
        .time-picker-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .time-picker-content {
            background-color: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .time-picker-content h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .time-input-group {
            margin: 1rem 0;
        }
        .time-input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }
        .time-input-group input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: 'Monaco', 'Courier New', monospace;
        }
        .time-range-display {
            color: #666;
            font-size: 0.875rem;
            font-style: italic;
        }
        .history-item:hover {
            background: #e9ecef;
        }
        .history-query {
            font-family: monospace;
            color: #2c3e50;
        }
        .history-time {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
        }
        .facet-list {
            list-style: none;
        }
        .facet-item {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .facet-item:hover {
            background: #f8f9fa;
            cursor: pointer;
        }
        .facet-count {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .example-query {
            background: #f8f9fa;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }
        .example-query-text {
            font-family: monospace;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }
        .example-description {
            font-size: 0.875rem;
            color: #666;
        }
        .example-query:hover {
            background: #e9ecef;
            cursor: pointer;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .query-hint {
            font-size: 0.875rem;
            color: #666;
            margin-top: 0.25rem;
        }
        .clear-btn {
            background: #e74c3c;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }
        .clear-btn:hover {
            background: #c0392b;
        }
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 1rem 0;
        }
        .pagination button {
            padding: 0.5rem 1rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .pagination button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .pagination button:hover:not(:disabled) {
            background: #2980b9;
        }
        .pagination .page-info {
            color: #666;
            font-size: 0.875rem;
        }
        .sort-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            align-items: center;
        }
        .sort-controls label {
            font-size: 0.875rem;
            color: #666;
        }
        .sort-controls select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .results-table th {
            background: #3498db;
            color: white;
            padding: 0.75rem;
            text-align: left;
            border: 1px solid #ddd;
            font-weight: 500;
        }
        .results-table td {
            padding: 0.5rem 0.75rem;
            border: 1px solid #ddd;
        }
        .results-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .results-table tr:hover {
            background: #e3f2fd;
        }
        #resultChart {
            max-height: 500px;
            margin-top: 1rem;
        }
        .time-refinement-popup {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 280px;
            padding: 0;
        }
        .time-refinement-popup.active {
            display: block;
        }
        .time-popup-header {
            background: #2c3e50;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .time-popup-section {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        .time-popup-section:last-child {
            border-bottom: none;
        }
        .time-popup-section-title {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            color: #666;
            font-weight: 500;
            text-transform: uppercase;
        }
        .time-popup-option {
            padding: 0.6rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .time-popup-option:hover {
            background: #f0f0f0;
        }
        .time-popup-option-icon {
            width: 20px;
            text-align: center;
            color: #3498db;
        }
        .time-popup-custom {
            padding: 0.75rem 1rem;
        }
        .time-popup-custom-row {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .time-popup-custom-row input {
            flex: 1;
            padding: 0.4rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .time-popup-custom-row select {
            padding: 0.4rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .time-popup-custom-row button {
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem;
        }
        .timestamp-clickable {
            cursor: pointer;
            color: #3498db;
            text-decoration: underline;
            text-decoration-style: dotted;
        }
        .timestamp-clickable:hover {
            color: #2980b9;
            text-decoration-style: solid;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Local Log Search</h1>
        <div class="nav-links">
            <a href="#" class="nav-link active" data-page="search">Search</a>
            <a href="#" class="nav-link" data-page="examples">Query Examples</a>
            <a href="/ui/sources.html" class="nav-link">üìÅ Log Sources</a>
        </div>
    </div>
    
    <div class="container">
        <!-- Search Page -->
        <div id="search" class="page active">
            <div class="two-col">
                <div>
                    <div class="card">
                        <h2>Search Logs</h2>
                        <form id="searchForm">
                            <div class="form-group">
                                <label for="indices">Indices</label>
                                <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <select id="indicesSelect" multiple size="4" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                                            <option value="">Loading indices...</option>
                                        </select>
                                        <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">Hold Ctrl/Cmd to select multiple</div>
                                    </div>
                                    <button type="button" id="refreshIndicesBtn" class="secondary" style="padding: 0.5rem; white-space: nowrap;">üîÑ Refresh</button>
                                </div>
                                <input type="text" id="indices" placeholder="app-logs, access-logs" value="app-logs" style="display: none;">
                            </div>
                            <div class="form-group">
                                <label for="query">Query</label>
                                <input type="text" id="query" placeholder="level:ERROR | stats count by user" value="">
                                <div class="query-hint">
                                    Use field:value for exact matches, field:[min TO max] for ranges. Pipe commands (|) enable aggregations: | stats, | chart, | timechart. See Query Examples for details.
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Time Range</label>
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                                    <select id="quickTimeRange" style="flex: 1; min-width: 150px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.875rem;">
                                        <option value="">All time (default)</option>
                                        <option value="5m">Last 5 minutes</option>
                                        <option value="15m">Last 15 minutes</option>
                                        <option value="30m">Last 30 minutes</option>
                                        <option value="1h">Last 1 hour</option>
                                        <option value="2h">Last 2 hours</option>
                                        <option value="4h">Last 4 hours</option>
                                        <option value="12h">Last 12 hours</option>
                                        <option value="24h">Last 24 hours</option>
                                        <option value="7d">Last 7 days</option>
                                        <option value="30d">Last 30 days</option>
                                        <option value="custom">Custom range...</option>
                                    </select>
                                    <button type="button" class="time-picker-btn" id="timeRangeBtn" style="white-space: nowrap;">
                                        üïê Custom
                                    </button>
                                </div>
                                <div class="time-range-display" id="timeRangeDisplay">All time</div>
                            </div>
                            <div class="bucket-config">
                                <div class="bucket-config-header" id="bucketConfigToggle">
                                    <label style="margin: 0; cursor: pointer;">‚öôÔ∏è Facet Bucketing (optional)</label>
                                    <span id="bucketToggleIcon">‚ñº</span>
                                </div>
                                <div class="bucket-config-content" id="bucketConfigContent" style="display: none;">
                                    <div id="bucketFieldsList"></div>
                                    <div class="add-bucket-controls">
                                        <input type="text" id="newBucketField" placeholder="Field name (e.g., duration)">
                                        <input type="text" id="newBucketRanges" placeholder="Ranges (e.g., 0,100,500,1000)">
                                        <button type="button" class="secondary" id="addBucketBtn" style="white-space: nowrap;">+ Add</button>
                                    </div>
                                </div>
                            </div>
                            <div class="button-group">
                                <button type="submit">Search</button>
                                <button type="button" class="secondary" id="clearBtn">Clear</button>
                            </div>
                        </form>
                        
                        <div id="message"></div>
                    </div>
                    
                    <div class="card" id="resultsCard" style="display:none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h2 style="margin: 0;">Results (<span id="totalHits">0</span> hits)</h2>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="secondary" id="exportBtn" style="font-size: 0.875rem; padding: 0.5rem 1rem;">üì• Export</button>
                                <button class="share" id="shareBtn">üìã Share Query</button>
                            </div>
                        </div>
                        <div id="exportOptions" style="display: none; margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 4px;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button id="exportCsv" style="background: #27ae60; font-size: 0.875rem; padding: 0.5rem 1rem;">CSV</button>
                                <button id="exportJson" style="background: #2980b9; font-size: 0.875rem; padding: 0.5rem 1rem;">JSON</button>
                                <button id="exportPdf" style="background: #c0392b; font-size: 0.875rem; padding: 0.5rem 1rem;" disabled>PDF (Charts Only)</button>
                            </div>
                        </div>
                        <div class="sort-controls">
                            <label for="sortField">Sort by:</label>
                            <select id="sortField">
                                <option value="score">Relevance</option>
                                <option value="timestamp" selected>Timestamp</option>
                                <option value="level">Level</option>
                                <option value="user">User</option>
                                <option value="operation">Operation</option>
                                <option value="status">Status</option>
                            </select>
                            <select id="sortOrder">
                                <option value="desc" selected>Descending</option>
                                <option value="asc">Ascending</option>
                            </select>
                        </div>
                        <div class="results" id="results"></div>
                        <div class="pagination" id="pagination" style="display:none;">
                            <button id="prevPage">‚Üê Previous</button>
                            <span class="page-info">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
                            <button id="nextPage">Next ‚Üí</button>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar">
                    <div class="card">
                        <h2>Search History</h2>
                        <button class="clear-btn" id="clearHistory" style="margin-bottom: 1rem; width: 100%;">Clear History</button>
                        <div id="historyList"></div>
                    </div>
                    
                    <div class="card" id="facetsCard" style="display:none;">
                        <h2>Field Facets</h2>
                        <div id="facetsList"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Examples Page -->
        <div id="examples" class="page">
            <div class="card">
                <h2>Query Examples</h2>
                <p style="margin-bottom: 1rem; color: #666;">Click on any example to try it in the search box.</p>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">Basic Queries</h3>
                <div class="example-query" data-query="ERROR">
                    <div class="example-query-text">ERROR</div>
                    <div class="example-description">Search for "ERROR" in any field</div>
                </div>
                <div class="example-query" data-query="level:ERROR">
                    <div class="example-query-text">level:ERROR</div>
                    <div class="example-description">Search for ERROR in the level field</div>
                </div>
                <div class="example-query" data-query="user:admin">
                    <div class="example-query-text">user:admin</div>
                    <div class="example-description">Search for admin user</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">Boolean Operators</h3>
                <div class="example-query" data-query="level:ERROR AND user:admin">
                    <div class="example-query-text">level:ERROR AND user:admin</div>
                    <div class="example-description">Both conditions must be true</div>
                </div>
                <div class="example-query" data-query="level:ERROR OR level:WARN">
                    <div class="example-query-text">level:ERROR OR level:WARN</div>
                    <div class="example-description">Either condition must be true</div>
                </div>
                <div class="example-query" data-query="ERROR NOT connection">
                    <div class="example-query-text">ERROR NOT connection</div>
                    <div class="example-description">ERROR but not connection</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">Wildcards</h3>
                <div class="example-query" data-query="user:john*">
                    <div class="example-query-text">user:john*</div>
                    <div class="example-description">Starts with "john"</div>
                </div>
                <div class="example-query" data-query="operation:*Order">
                    <div class="example-query-text">operation:*Order</div>
                    <div class="example-description">Ends with "Order"</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">Range Queries</h3>
                <div class="example-query" data-query="duration:[100 TO 500]">
                    <div class="example-query-text">duration:[100 TO 500]</div>
                    <div class="example-description">Duration between 100 and 500 (text comparison)</div>
                </div>
                <div class="example-query" data-query="status:[500 TO 599]">
                    <div class="example-query-text">status:[500 TO 599]</div>
                    <div class="example-description">HTTP 5xx errors</div>
                </div>
                <div class="example-query" data-query="duration:[400 TO *]">
                    <div class="example-query-text">duration:[400 TO *]</div>
                    <div class="example-description">Duration 400 or greater</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">Complex Queries</h3>
                <div class="example-query" data-query="(level:ERROR OR level:WARN) AND user:admin">
                    <div class="example-query-text">(level:ERROR OR level:WARN) AND user:admin</div>
                    <div class="example-description">Grouped conditions with AND/OR</div>
                </div>
                <div class="example-query" data-query="level:ERROR AND operation:processOrder AND duration:[100 TO *]">
                    <div class="example-query-text">level:ERROR AND operation:processOrder AND duration:[100 TO *]</div>
                    <div class="example-description">Multiple field constraints</div>
                </div>
                <div class="example-query" data-query='raw_text:"connection timeout"'>
                    <div class="example-query-text">raw_text:"connection timeout"</div>
                    <div class="example-description">Exact phrase search in raw log text</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">Common Use Cases</h3>
                <div class="example-query" data-query="status:slow">
                    <div class="example-query-text">status:slow</div>
                    <div class="example-description">Find slow operations</div>
                </div>
                <div class="example-query" data-query="level:ERROR AND component:database">
                    <div class="example-query-text">level:ERROR AND component:database</div>
                    <div class="example-description">Database errors</div>
                </div>
                <div class="example-query" data-query="method:POST AND status:[400 TO 499]">
                    <div class="example-query-text">method:POST AND status:[400 TO 499]</div>
                    <div class="example-description">Failed POST requests</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">üìä Pipe Commands - Stats</h3>
                <div class="example-query" data-query="level:ERROR | stats count">
                    <div class="example-query-text">level:ERROR | stats count</div>
                    <div class="example-description">Count total errors</div>
                </div>
                <div class="example-query" data-query="level:ERROR | stats count by user">
                    <div class="example-query-text">level:ERROR | stats count by user</div>
                    <div class="example-description">Count errors per user</div>
                </div>
                <div class="example-query" data-query="* | stats count avg(duration) by operation">
                    <div class="example-query-text">* | stats count avg(duration) by operation</div>
                    <div class="example-description">Count and average duration per operation</div>
                </div>
                <div class="example-query" data-query="status:slow | stats min(duration) max(duration) avg(duration) by user">
                    <div class="example-query-text">status:slow | stats min(duration) max(duration) avg(duration) by user</div>
                    <div class="example-description">Duration statistics for slow operations by user</div>
                </div>
                <div class="example-query" data-query="* | stats dc(user) by operation">
                    <div class="example-query-text">* | stats dc(user) by operation</div>
                    <div class="example-description">Count distinct users per operation</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">üìà Pipe Commands - Charts</h3>
                <div class="example-query" data-query="level:ERROR | chart count by user">
                    <div class="example-query-text">level:ERROR | chart count by user</div>
                    <div class="example-description">Bar chart of errors by user</div>
                </div>
                <div class="example-query" data-query="level:ERROR | chart type=pie count by operation">
                    <div class="example-query-text">level:ERROR | chart type=pie count by operation</div>
                    <div class="example-description">Pie chart of error distribution by operation</div>
                </div>
                <div class="example-query" data-query="status:slow | chart type=bar avg(duration) by operation">
                    <div class="example-query-text">status:slow | chart type=bar avg(duration) by operation</div>
                    <div class="example-description">Bar chart of average duration for slow operations</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">üìâ Pipe Commands - Time Charts</h3>
                <div class="example-query" data-query="* | timechart span=1h count">
                    <div class="example-query-text">* | timechart span=1h count</div>
                    <div class="example-description">Hourly event count over time</div>
                </div>
                <div class="example-query" data-query="level:ERROR | timechart span=5m count">
                    <div class="example-query-text">level:ERROR | timechart span=5m count</div>
                    <div class="example-description">Error count per 5 minutes</div>
                </div>
                <div class="example-query" data-query="level:ERROR | timechart span=30m count by user">
                    <div class="example-query-text">level:ERROR | timechart span=30m count by user</div>
                    <div class="example-description">Error trends per user every 30 minutes</div>
                </div>
                <div class="example-query" data-query="(level:ERROR OR level:WARN) | timechart span=15m count by level">
                    <div class="example-query-text">(level:ERROR OR level:WARN) | timechart span=15m count by level</div>
                    <div class="example-description">Compare ERROR vs WARN trends over time</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">üí° Pipe Command Tips</h3>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                    <p style="margin: 0 0 0.5rem 0; font-weight: bold; color: #2c3e50;">Aggregation Functions:</p>
                    <ul style="margin: 0; padding-left: 1.5rem; color: #666;">
                        <li><code>count</code> - Count of results</li>
                        <li><code>sum(field)</code> - Sum of numeric values</li>
                        <li><code>avg(field)</code> - Average of numeric values</li>
                        <li><code>min(field)</code> - Minimum value</li>
                        <li><code>max(field)</code> - Maximum value</li>
                        <li><code>dc(field)</code> - Distinct count</li>
                    </ul>
                    <p style="margin: 1rem 0 0.5rem 0; font-weight: bold; color: #2c3e50;">Time Spans:</p>
                    <ul style="margin: 0; padding-left: 1.5rem; color: #666;">
                        <li><code>span=Ns</code> - Seconds (e.g., span=30s)</li>
                        <li><code>span=Nm</code> - Minutes (e.g., span=5m)</li>
                        <li><code>span=Nh</code> - Hours (e.g., span=1h)</li>
                        <li><code>span=Nd</code> - Days (e.g., span=1d)</li>
                    </ul>
                    <p style="margin: 1rem 0 0.5rem 0; font-weight: bold; color: #2c3e50;">Chart Types:</p>
                    <ul style="margin: 0; padding-left: 1.5rem; color: #666;">
                        <li><code>type=bar</code> - Bar chart (default)</li>
                        <li><code>type=pie</code> - Pie chart</li>
                        <li><code>type=line</code> - Line chart</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Range Picker Modal -->
    <div id="timePickerModal" class="time-picker-modal">
        <div class="time-picker-content">
            <span class="share-modal-close" id="timePickerClose">&times;</span>
            <h3>Select Time Range</h3>
            
            <div class="time-input-group">
                <label for="timeFrom">From (ISO format with millis)</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="timeFrom" placeholder="2025-11-15T10:30:45.123Z" style="flex: 1;">
                    <button type="button" id="setFromNow" class="secondary" style="padding: 0.5rem; white-space: nowrap;">Now</button>
                </div>
                <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">Format: YYYY-MM-DDTHH:mm:ss.sssZ</div>
            </div>
            
            <div class="time-input-group">
                <label for="timeTo">To (ISO format with millis)</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="timeTo" placeholder="2025-11-15T10:35:45.123Z" style="flex: 1;">
                    <button type="button" id="setToNow" class="secondary" style="padding: 0.5rem; white-space: nowrap;">Now</button>
                </div>
                <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">Format: YYYY-MM-DDTHH:mm:ss.sssZ</div>
            </div>
            
            <div class="button-group" style="margin-top: 1.5rem;">
                <button type="button" id="applyTimeRange">Apply</button>
                <button type="button" class="secondary" id="clearTimeRange">Clear</button>
                <button type="button" class="secondary" id="cancelTimeRange">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Share Query Modal -->
    <div id="shareModal" class="share-modal">
        <div class="share-modal-content">
            <span class="share-modal-close" id="shareModalClose">&times;</span>
            <h2>Share Query</h2>
            
            <div class="share-option">
                <label>Shareable URL</label>
                <div class="share-code">
                    <button class="copy-btn" data-copy="url">Copy</button>
                    <div id="shareUrl"></div>
                </div>
            </div>
            
            <div class="share-option">
                <label>cURL Command</label>
                <div class="share-code">
                    <button class="copy-btn" data-copy="curl">Copy</button>
                    <div id="shareCurl"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Refinement Popup -->
    <div id="timeRefinementPopup" class="time-refinement-popup">
        <div class="time-popup-header">
            Refine by Time
        </div>
        <div class="time-popup-section">
            <div class="time-popup-section-title">Quick Actions</div>
            <div class="time-popup-option" data-action="before">
                <span class="time-popup-option-icon">‚óÄ</span>
                <span>Before this time</span>
            </div>
            <div class="time-popup-option" data-action="after">
                <span class="time-popup-option-icon">‚ñ∂</span>
                <span>After this time</span>
            </div>
            <div class="time-popup-option" data-action="around">
                <span class="time-popup-option-icon">‚óÜ</span>
                <span>Around this time (¬±5 min)</span>
            </div>
        </div>
        <div class="time-popup-section">
            <div class="time-popup-section-title">Before by...</div>
            <div class="time-popup-option" data-action="before-custom" data-amount="1000" data-unit="ms">
                <span class="time-popup-option-icon">‚óÄ</span>
                <span>1 second</span>
            </div>
            <div class="time-popup-option" data-action="before-custom" data-amount="5000" data-unit="ms">
                <span class="time-popup-option-icon">‚óÄ</span>
                <span>5 seconds</span>
            </div>
            <div class="time-popup-option" data-action="before-custom" data-amount="60000" data-unit="ms">
                <span class="time-popup-option-icon">‚óÄ</span>
                <span>1 minute</span>
            </div>
            <div class="time-popup-option" data-action="before-custom" data-amount="300000" data-unit="ms">
                <span class="time-popup-option-icon">‚óÄ</span>
                <span>5 minutes</span>
            </div>
            <div class="time-popup-option" data-action="before-custom" data-amount="3600000" data-unit="ms">
                <span class="time-popup-option-icon">‚óÄ</span>
                <span>1 hour</span>
            </div>
        </div>
        <div class="time-popup-section">
            <div class="time-popup-section-title">After by...</div>
            <div class="time-popup-option" data-action="after-custom" data-amount="1000" data-unit="ms">
                <span class="time-popup-option-icon">‚ñ∂</span>
                <span>1 second</span>
            </div>
            <div class="time-popup-option" data-action="after-custom" data-amount="5000" data-unit="ms">
                <span class="time-popup-option-icon">‚ñ∂</span>
                <span>5 seconds</span>
            </div>
            <div class="time-popup-option" data-action="after-custom" data-amount="60000" data-unit="ms">
                <span class="time-popup-option-icon">‚ñ∂</span>
                <span>1 minute</span>
            </div>
            <div class="time-popup-option" data-action="after-custom" data-amount="300000" data-unit="ms">
                <span class="time-popup-option-icon">‚ñ∂</span>
                <span>5 minutes</span>
            </div>
            <div class="time-popup-option" data-action="after-custom" data-amount="3600000" data-unit="ms">
                <span class="time-popup-option-icon">‚ñ∂</span>
                <span>1 hour</span>
            </div>
        </div>
        <div class="time-popup-section">
            <div class="time-popup-section-title">Around by...</div>
            <div class="time-popup-option" data-action="around-custom" data-amount="1000" data-unit="ms">
                <span class="time-popup-option-icon">‚óÜ</span>
                <span>¬±1 second</span>
            </div>
            <div class="time-popup-option" data-action="around-custom" data-amount="5000" data-unit="ms">
                <span class="time-popup-option-icon">‚óÜ</span>
                <span>¬±5 seconds</span>
            </div>
            <div class="time-popup-option" data-action="around-custom" data-amount="60000" data-unit="ms">
                <span class="time-popup-option-icon">‚óÜ</span>
                <span>¬±1 minute</span>
            </div>
            <div class="time-popup-option" data-action="around-custom" data-amount="300000" data-unit="ms">
                <span class="time-popup-option-icon">‚óÜ</span>
                <span>¬±5 minutes</span>
            </div>
            <div class="time-popup-option" data-action="around-custom" data-amount="3600000" data-unit="ms">
                <span class="time-popup-option-icon">‚óÜ</span>
                <span>¬±1 hour</span>
            </div>
        </div>
        <div class="time-popup-section time-popup-custom">
            <div class="time-popup-section-title" style="padding-left: 0;">Custom Range</div>
            <div class="time-popup-custom-row">
                <input type="number" id="customTimeAmount" placeholder="Amount" min="1" value="5">
                <select id="customTimeUnit">
                    <option value="ms">Milliseconds</option>
                    <option value="s" selected>Seconds</option>
                    <option value="m">Minutes</option>
                    <option value="h">Hours</option>
                    <option value="d">Days</option>
                </select>
            </div>
            <div class="time-popup-custom-row">
                <button id="customBefore">‚óÄ Before</button>
                <button id="customAfter">‚ñ∂ After</button>
                <button id="customAround">‚óÜ Around</button>
            </div>
        </div>
    </div>

    <script>
        // State management
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        let facetBuckets = {}; // field -> {ranges: [...]}
        let availableIndices = [];
        let currentTimestamp = null;
        
        // Time refinement popup management
        function showTimeRefinementPopup(timestamp, x, y) {
            currentTimestamp = timestamp;
            const popup = document.getElementById('timeRefinementPopup');
            popup.classList.add('active');
            
            // Position popup near click, but keep it on screen
            const rect = popup.getBoundingClientRect();
            const maxX = window.innerWidth - rect.width - 20;
            const maxY = window.innerHeight - rect.height - 20;
            
            popup.style.left = Math.min(x, maxX) + 'px';
            popup.style.top = Math.min(y, maxY) + 'px';
        }
        
        function hideTimeRefinementPopup() {
            document.getElementById('timeRefinementPopup').classList.remove('active');
            currentTimestamp = null;
        }
        
        // Convert time amount and unit to milliseconds
        function getMilliseconds(amount, unit) {
            const conversions = {
                'ms': 1,
                's': 1000,
                'm': 60000,
                'h': 3600000,
                'd': 86400000
            };
            return amount * conversions[unit];
        }
        
        // Apply time refinement to search
        function applyTimeRefinement(action, amount = null, unit = null) {
            if (!currentTimestamp) return;
            
            const timestamp = new Date(currentTimestamp);
            const timestampMs = timestamp.getTime();
            
            let fromDate, toDate;
            
            switch(action) {
                case 'before':
                    // Everything before this timestamp
                    toDate = timestamp.toISOString();
                    break;
                    
                case 'after':
                    // Everything after this timestamp
                    fromDate = timestamp.toISOString();
                    break;
                    
                case 'around':
                    // ¬±5 minutes by default
                    const defaultRange = 5 * 60 * 1000; // 5 minutes in ms
                    fromDate = new Date(timestampMs - defaultRange).toISOString();
                    toDate = new Date(timestampMs + defaultRange).toISOString();
                    break;
                    
                case 'before-custom':
                    // Before by specified amount
                    const millisBefore = getMilliseconds(amount, unit);
                    toDate = new Date(timestampMs - millisBefore).toISOString();
                    break;
                    
                case 'after-custom':
                    // After by specified amount
                    const millisAfter = getMilliseconds(amount, unit);
                    fromDate = new Date(timestampMs + millisAfter).toISOString();
                    break;
                    
                case 'around-custom':
                    // Around by specified amount
                    const millisAround = getMilliseconds(amount, unit);
                    fromDate = new Date(timestampMs - millisAround).toISOString();
                    toDate = new Date(timestampMs + millisAround).toISOString();
                    break;
            }
            
            // Update time range inputs with full ISO format (including milliseconds)
            if (fromDate) {
                document.getElementById('timeFrom').value = fromDate; // Full ISO string
            } else {
                document.getElementById('timeFrom').value = '';
            }
            
            if (toDate) {
                document.getElementById('timeTo').value = toDate; // Full ISO string
            } else {
                document.getElementById('timeTo').value = '';
            }
            
            // Apply the time range (simulate clicking apply button)
            document.getElementById('applyTimeRange').click();
            
            // Close popup
            hideTimeRefinementPopup();
        }
        
        // Load available indices
        async function loadIndices() {
            try {
                const response = await fetch('/api/indices');
                if (response.ok) {
                    availableIndices = await response.json();
                    renderIndicesSelect();
                } else {
                    console.error('Failed to load indices');
                    document.getElementById('indicesSelect').innerHTML = '<option value="">Error loading indices</option>';
                }
            } catch (error) {
                console.error('Error loading indices:', error);
                document.getElementById('indicesSelect').innerHTML = '<option value="">Error loading indices</option>';
            }
        }
        
        function renderIndicesSelect() {
            const select = document.getElementById('indicesSelect');
            
            if (availableIndices.length === 0) {
                select.innerHTML = '<option value="">No indices found</option>';
                return;
            }
            
            // Get currently selected values from the hidden input (for initial load or history)
            const hiddenInput = document.getElementById('indices');
            const currentlySelected = hiddenInput.value.split(',').map(s => s.trim()).filter(s => s);
            
            select.innerHTML = '';
            availableIndices.forEach(index => {
                const option = document.createElement('option');
                option.value = index.name;
                const docCount = index.documentCount ? index.documentCount.toLocaleString() : '0';
                const size = index.sizeFormatted || '0 B';
                option.textContent = `${index.name} (${docCount} docs, ${size})`;
                
                // Select if it was previously selected
                if (currentlySelected.includes(index.name)) {
                    option.selected = true;
                }
                
                select.appendChild(option);
            });
            
            // Update hidden input when selection changes
            select.addEventListener('change', updateHiddenIndicesInput);
            
            // Initialize hidden input with selected values
            updateHiddenIndicesInput();
        }
        
        function updateHiddenIndicesInput() {
            const select = document.getElementById('indicesSelect');
            const selectedOptions = Array.from(select.selectedOptions);
            const selectedIndices = selectedOptions.map(opt => opt.value).join(', ');
            document.getElementById('indices').value = selectedIndices;
        }
        
        // Refresh indices button
        document.getElementById('refreshIndicesBtn').addEventListener('click', async () => {
            const btn = document.getElementById('refreshIndicesBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Loading...';
            await loadIndices();
            btn.disabled = false;
            btn.textContent = 'üîÑ Refresh';
        });
        
        // Load indices on page load
        loadIndices();
        
        // Page navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                const page = e.target.dataset.page;
                
                // If no data-page attribute, allow default navigation (external links)
                if (!page) {
                    return;
                }
                
                e.preventDefault();
                
                // Update active nav
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                e.target.classList.add('active');
                
                // Show page
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(page).classList.add('active');
            });
        });
        
        // Example queries
        document.querySelectorAll('.example-query').forEach(ex => {
            ex.addEventListener('click', () => {
                const query = ex.dataset.query;
                document.getElementById('query').value = query;
                
                // Switch to search page
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelector('[data-page="search"]').classList.add('active');
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('search').classList.add('active');
                
                document.getElementById('query').focus();
            });
        });
        
        // Search history
        function addToHistory(query, indices) {
            const entry = {
                query,
                indices,
                timestamp: new Date().toISOString(),
                timeRange: {
                    from: currentTimeRange.from,
                    to: currentTimeRange.to
                },
                facetBuckets: Object.keys(facetBuckets).length > 0 ? JSON.parse(JSON.stringify(facetBuckets)) : null
            };
            
            searchHistory.unshift(entry);
            if (searchHistory.length > 10) {
                searchHistory = searchHistory.slice(0, 10);
            }
            
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            renderHistory();
        }
        
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            
            if (searchHistory.length === 0) {
                historyList.innerHTML = '<div style="color: #999; font-size: 0.875rem;">No search history</div>';
                return;
            }
            
            historyList.innerHTML = searchHistory.map((entry, index) => {
                let timeRangeInfo = '';
                if (entry.timeRange && (entry.timeRange.from || entry.timeRange.to)) {
                    const fromStr = entry.timeRange.from ? new Date(entry.timeRange.from).toLocaleString() : 'Start';
                    const toStr = entry.timeRange.to ? new Date(entry.timeRange.to).toLocaleString() : 'End';
                    timeRangeInfo = `<div style="font-size: 0.7rem; color: #3498db; margin-top: 0.25rem;">üïê ${fromStr} ‚Üí ${toStr}</div>`;
                }
                
                let bucketInfo = '';
                if (entry.facetBuckets && Object.keys(entry.facetBuckets).length > 0) {
                    const bucketCount = Object.keys(entry.facetBuckets).length;
                    const bucketFields = Object.keys(entry.facetBuckets).join(', ');
                    bucketInfo = `<div style="font-size: 0.7rem; color: #9b59b6; margin-top: 0.25rem;" title="Bucketed fields: ${bucketFields}">‚öôÔ∏è ${bucketCount} bucketed field${bucketCount > 1 ? 's' : ''}</div>`;
                }
                
                return `
                    <div class="history-item" data-index="${index}">
                        <div class="history-query">${entry.query}</div>
                        <div class="history-time">${new Date(entry.timestamp).toLocaleString()}</div>
                        ${timeRangeInfo}
                        ${bucketInfo}
                    </div>
                `;
            }).join('');
            
            // Add click handlers
            document.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    const entry = searchHistory[index];
                    
                    document.getElementById('query').value = entry.query;
                    document.getElementById('indices').value = entry.indices;
                    
                    // Update dropdown selection to match restored indices
                    renderIndicesSelect();
                    
                    // Restore time range if present
                    if (entry.timeRange) {
                        if (entry.timeRange.from) {
                            timeFrom.value = entry.timeRange.from;
                            currentTimeRange.from = entry.timeRange.from;
                        } else {
                            timeFrom.value = '';
                            currentTimeRange.from = null;
                        }
                        
                        if (entry.timeRange.to) {
                            timeTo.value = entry.timeRange.to;
                            currentTimeRange.to = entry.timeRange.to;
                        } else {
                            timeTo.value = '';
                            currentTimeRange.to = null;
                        }
                        
                        // Update display with milliseconds
                        if (currentTimeRange.from || currentTimeRange.to) {
                            const fromStr = currentTimeRange.from ? new Date(currentTimeRange.from).toLocaleString() + '.' + new Date(currentTimeRange.from).getMilliseconds() : 'Start';
                            const toStr = currentTimeRange.to ? new Date(currentTimeRange.to).toLocaleString() + '.' + new Date(currentTimeRange.to).getMilliseconds() : 'End';
                            timeRangeDisplay.textContent = `${fromStr} ‚Üí ${toStr}`;
                        } else {
                            timeRangeDisplay.textContent = 'All time';
                        }
                    } else {
                        // Clear time range if not present in history entry
                        timeFrom.value = '';
                        timeTo.value = '';
                        currentTimeRange = { from: null, to: null };
                        timeRangeDisplay.textContent = 'All time';
                    }
                    
                    // Restore facet buckets if present
                    if (entry.facetBuckets) {
                        facetBuckets = JSON.parse(JSON.stringify(entry.facetBuckets));
                    } else {
                        facetBuckets = {};
                    }
                    renderBucketFields();
                });
            });
        }
        
        document.getElementById('clearHistory').addEventListener('click', () => {
            searchHistory = [];
            localStorage.removeItem('searchHistory');
            renderHistory();
        });
        
        // Bucket Configuration Management
        function renderBucketFields() {
            const bucketFieldsList = document.getElementById('bucketFieldsList');
            
            if (Object.keys(facetBuckets).length === 0) {
                bucketFieldsList.innerHTML = '<div style="color: #999; font-size: 0.875rem; margin-bottom: 0.5rem;">No bucketing configured</div>';
                return;
            }
            
            let html = '';
            Object.entries(facetBuckets).forEach(([field, config]) => {
                html += `
                    <div class="bucket-field">
                        <div class="bucket-field-header">
                            <span class="bucket-field-name">${field}</span>
                            <button class="remove-bucket-btn" data-field="${field}">Remove</button>
                        </div>
                        <div class="bucket-ranges">Ranges: [${config.ranges.join(', ')}]</div>
                    </div>
                `;
            });
            
            bucketFieldsList.innerHTML = html;
            
            // Add remove handlers
            document.querySelectorAll('.remove-bucket-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    delete facetBuckets[btn.dataset.field];
                    renderBucketFields();
                });
            });
        }
        
        // Bucket config toggle
        document.getElementById('bucketConfigToggle').addEventListener('click', () => {
            const content = document.getElementById('bucketConfigContent');
            const icon = document.getElementById('bucketToggleIcon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        });
        
        // Add bucket button
        document.getElementById('addBucketBtn').addEventListener('click', () => {
            const fieldInput = document.getElementById('newBucketField');
            const rangesInput = document.getElementById('newBucketRanges');
            
            const field = fieldInput.value.trim();
            const rangesStr = rangesInput.value.trim();
            
            if (!field) {
                alert('Please enter a field name');
                return;
            }
            
            if (!rangesStr) {
                alert('Please enter ranges (e.g., 0,100,500,1000)');
                return;
            }
            
            // Parse ranges
            const ranges = rangesStr.split(',').map(r => {
                const num = parseFloat(r.trim());
                if (isNaN(num)) {
                    throw new Error(`Invalid number: ${r}`);
                }
                return num;
            });
            
            if (ranges.length < 2) {
                alert('Please enter at least 2 range values');
                return;
            }
            
            facetBuckets[field] = { ranges: ranges };
            renderBucketFields();
            
            // Clear inputs
            fieldInput.value = '';
            rangesInput.value = '';
        });
        
        renderBucketFields();
        
        // Time Range Picker Modal
        const timePickerModal = document.getElementById('timePickerModal');
        const timeRangeBtn = document.getElementById('timeRangeBtn');
        const timePickerClose = document.getElementById('timePickerClose');
        const applyTimeRange = document.getElementById('applyTimeRange');
        const clearTimeRange = document.getElementById('clearTimeRange');
        const cancelTimeRange = document.getElementById('cancelTimeRange');
        const timeFrom = document.getElementById('timeFrom');
        const timeTo = document.getElementById('timeTo');
        const timeRangeDisplay = document.getElementById('timeRangeDisplay');
        
        // Store time range globally
        let currentTimeRange = { from: null, to: null };
        
        timeRangeBtn.addEventListener('click', () => {
            timePickerModal.style.display = 'block';
        });
        
        timePickerClose.addEventListener('click', () => {
            timePickerModal.style.display = 'none';
        });
        
        cancelTimeRange.addEventListener('click', () => {
            timePickerModal.style.display = 'none';
        });
        
        applyTimeRange.addEventListener('click', () => {
            // Parse and validate ISO timestamp format
            const parseISOTimestamp = (value) => {
                if (!value) return null;
                try {
                    const date = new Date(value);
                    if (isNaN(date.getTime())) {
                        return null;
                    }
                    return date.toISOString();
                } catch (e) {
                    return null;
                }
            };
            
            const fromISO = parseISOTimestamp(timeFrom.value);
            const toISO = parseISOTimestamp(timeTo.value);
            
            if (fromISO === null && timeFrom.value) {
                alert('Invalid "From" timestamp format. Use ISO format: YYYY-MM-DDTHH:mm:ss.sssZ');
                return;
            }
            
            if (toISO === null && timeTo.value) {
                alert('Invalid "To" timestamp format. Use ISO format: YYYY-MM-DDTHH:mm:ss.sssZ');
                return;
            }
            
            currentTimeRange.from = fromISO;
            currentTimeRange.to = toISO;
            
            if (currentTimeRange.from || currentTimeRange.to) {
                const fromStr = currentTimeRange.from ? new Date(currentTimeRange.from).toLocaleString() + '.' + new Date(currentTimeRange.from).getMilliseconds() : 'Start';
                const toStr = currentTimeRange.to ? new Date(currentTimeRange.to).toLocaleString() + '.' + new Date(currentTimeRange.to).getMilliseconds() : 'End';
                timeRangeDisplay.textContent = `${fromStr} ‚Üí ${toStr}`;
            } else {
                timeRangeDisplay.textContent = 'All time';
            }
            
            timePickerModal.style.display = 'none';
        });
        
        clearTimeRange.addEventListener('click', () => {
            timeFrom.value = '';
            timeTo.value = '';
            currentTimeRange = { from: null, to: null };
            timeRangeDisplay.textContent = 'All time';
            quickTimeRangeSelect.value = ''; // Reset to "All time"
            timePickerModal.style.display = 'none';
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === timePickerModal) {
                timePickerModal.style.display = 'none';
            }
        });
        
        // "Now" button handlers for time inputs
        document.getElementById('setFromNow').addEventListener('click', () => {
            timeFrom.value = new Date().toISOString();
        });
        
        document.getElementById('setToNow').addEventListener('click', () => {
            timeTo.value = new Date().toISOString();
        });
        
        // Quick time range selector (Last N minutes/hours)
        const quickTimeRangeSelect = document.getElementById('quickTimeRange');
        quickTimeRangeSelect.addEventListener('change', (e) => {
            const value = e.target.value;
            
            if (value === '' || !value) {
                // All time - clear custom range
                timeFrom.value = '';
                timeTo.value = '';
                currentTimeRange = { from: null, to: null };
                timeRangeDisplay.textContent = 'All time';
                return;
            }
            
            if (value === 'custom') {
                // Open custom time picker modal
                timePickerModal.style.display = 'block';
                return;
            }
            
            // Parse the time range (e.g., "5m", "1h", "7d")
            const amount = parseInt(value);
            const unit = value.slice(-1);
            
            const now = new Date();
            let milliseconds = 0;
            
            switch(unit) {
                case 'm': // minutes
                    milliseconds = amount * 60 * 1000;
                    break;
                case 'h': // hours
                    milliseconds = amount * 60 * 60 * 1000;
                    break;
                case 'd': // days
                    milliseconds = amount * 24 * 60 * 60 * 1000;
                    break;
            }
            
            const fromDate = new Date(now.getTime() - milliseconds);
            
            // Set time range
            currentTimeRange.from = fromDate.toISOString();
            currentTimeRange.to = now.toISOString();
            
            // Update display
            const optionText = e.target.options[e.target.selectedIndex].text;
            timeRangeDisplay.textContent = optionText;
            
            // Also update the modal inputs in case user opens it
            timeFrom.value = currentTimeRange.from;
            timeTo.value = currentTimeRange.to;
        });
        
        // When custom time range is applied, update the dropdown to "Custom range..."
        const originalApplyTimeRange = applyTimeRange.onclick;
        applyTimeRange.addEventListener('click', () => {
            // Check if a custom range was set
            if (currentTimeRange.from || currentTimeRange.to) {
                quickTimeRangeSelect.value = 'custom';
            }
        });
        
        // Clear button
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('query').value = '';
            timeFrom.value = '';
            timeTo.value = '';
            currentTimeRange = { from: null, to: null };
            timeRangeDisplay.textContent = 'All time';
            quickTimeRangeSelect.value = ''; // Reset to "All time"
            facetBuckets = {};
            renderBucketFields();
            document.getElementById('message').innerHTML = '';
            document.getElementById('resultsCard').style.display = 'none';
            document.getElementById('facetsCard').style.display = 'none';
        });
        
        // Add field constraint to query
        function addConstraint(field, value) {
            const queryInput = document.getElementById('query');
            let currentQuery = queryInput.value.trim();
            
            // Check if value is a bucket range like "100-500" or "<100" or "1000+"
            let constraint;
            
            if (value.includes('-') && !value.startsWith('<') && !value.startsWith('>')) {
                // Range like "100-500"
                const parts = value.split('-');
                if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                    // Numeric range - backend will automatically use numeric field if available
                    constraint = `${field}:[${parts[0]} TO ${parts[1]}]`;
                } else {
                    // Not a numeric range, treat as exact value
                    constraint = `${field}:"${value}"`;
                }
            } else if (value.startsWith('<')) {
                // Less than range
                const num = value.substring(1).trim();
                constraint = `${field}:[* TO ${num}]`;
            } else if (value.endsWith('+')) {
                // Greater than or equal range
                const num = value.substring(0, value.length - 1).trim();
                constraint = `${field}:[${num} TO *]`;
            } else {
                // Regular value - check if it needs quotes (contains spaces or special chars)
                if (value.includes(' ') || value.includes(':') || value.includes('&')) {
                    constraint = `${field}:"${value}"`;
                } else {
                    constraint = `${field}:${value}`;
                }
            }
            
            if (currentQuery === '') {
                queryInput.value = constraint;
            } else {
                queryInput.value = `${currentQuery} AND ${constraint}`;
            }
            
            queryInput.focus();
            
            // Auto-trigger search
            performSearch(0);
        }
        
        // Calculate facets from results
        function calculateFacets(results) {
            const facets = {};
            
            results.forEach(result => {
                if (result.fields) {
                    Object.entries(result.fields).forEach(([key, value]) => {
                        if (!facets[key]) {
                            facets[key] = {};
                        }
                        if (!facets[key][value]) {
                            facets[key][value] = 0;
                        }
                        facets[key][value]++;
                    });
                }
            });
            
            return facets;
        }
        
        function renderFacets(facets, facetSampleSize, totalHits) {
            const facetsCard = document.getElementById('facetsCard');
            const facetsList = document.getElementById('facetsList');
            
            if (!facets || Object.keys(facets).length === 0) {
                facetsCard.style.display = 'none';
                return;
            }
            
            facetsCard.style.display = 'block';
            
            const MAX_SHOW = 10;
            let html = '';
            
            // Show warning if facets are based on a sample
            if (facetSampleSize && totalHits && facetSampleSize < totalHits) {
                html += `
                    <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.875rem;">
                        ‚ö†Ô∏è <strong>Note:</strong> Facets calculated from ${facetSampleSize.toLocaleString()} of ${totalHits.toLocaleString()} matching documents (for performance).
                        Counts may not reflect all results.
                    </div>
                `;
            }
            
            Object.keys(facets).forEach(field => {
                const values = facets[field];
                const allEntries = Object.entries(values).sort((a, b) => b[1] - a[1]);
                const totalCount = Object.values(values).reduce((a,b) => a+b, 0);
                
                // Show top N values
                const topValues = allEntries.slice(0, MAX_SHOW);
                const remainingValues = allEntries.slice(MAX_SHOW);
                
                html += `
                    <h3 style="margin-top: 1rem; margin-bottom: 0.5rem; font-size: 1rem; color: #2c3e50; display: flex; align-items: center;">
                        <span>${field} (${totalCount} total)</span>
                        <span class="facet-gear" data-field="${field}" title="Configure bucketing for ${field}">‚öôÔ∏è</span>
                    </h3>
                `;
                html += '<ul class="facet-list">';
                
                topValues.forEach(([value, count]) => {
                    html += `
                        <li class="facet-item" data-field="${field}" data-value="${value}">
                            <span>${value}</span>
                            <span class="facet-count">${count}</span>
                        </li>
                    `;
                });
                
                // Add "Other" category if there are more values
                if (remainingValues.length > 0) {
                    const otherCount = remainingValues.reduce((sum, [_, count]) => sum + count, 0);
                    html += `
                        <li class="facet-item" style="opacity: 0.7; font-style: italic;" title="${remainingValues.length} other values">
                            <span>Other (${remainingValues.length} values)</span>
                            <span class="facet-count">${otherCount}</span>
                        </li>
                    `;
                }
                
                html += '</ul>';
            });
            
            facetsList.innerHTML = html;
            
            // Add click handlers (only for non-Other items)
            document.querySelectorAll('.facet-item[data-field]').forEach(item => {
                item.addEventListener('click', () => {
                    addConstraint(item.dataset.field, item.dataset.value);
                });
            });
            
            // Add gear icon click handlers
            document.querySelectorAll('.facet-gear').forEach(gear => {
                gear.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const field = gear.dataset.field;
                    
                    // Prompt for ranges
                    const currentRanges = facetBuckets[field] ? facetBuckets[field].ranges.join(',') : '';
                    const rangesStr = prompt(`Enter range values for "${field}" (comma-separated numbers):\n\nExample: 0,100,500,1000\nThis creates buckets: <0, 0-100, 100-500, 500-1000, 1000+`, currentRanges);
                    
                    if (rangesStr === null) return; // User cancelled
                    
                    if (rangesStr.trim() === '') {
                        // Remove bucketing for this field
                        delete facetBuckets[field];
                        renderBucketFields();
                        alert(`Bucketing removed for "${field}". Run the search again to see changes.`);
                        return;
                    }
                    
                    try {
                        // Parse ranges
                        const ranges = rangesStr.split(',').map(r => {
                            const num = parseFloat(r.trim());
                            if (isNaN(num)) {
                                throw new Error(`Invalid number: ${r}`);
                            }
                            return num;
                        });
                        
                        if (ranges.length < 2) {
                            alert('Please enter at least 2 range values');
                            return;
                        }
                        
                        facetBuckets[field] = { ranges: ranges };
                        renderBucketFields();
                        alert(`Bucketing configured for "${field}". Run the search again to see bucketed facets.`);
                    } catch (error) {
                        alert(`Error: ${error.message}`);
                    }
                });
            });
        }
        
        // Render functions for pipe results
        function renderTable(tableResult) {
            const resultsEl = document.getElementById('results');
            document.getElementById('pagination').style.display = 'none';
            
            let html = '<table class="results-table">';
            html += '<thead><tr>';
            tableResult.columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            tableResult.rows.forEach(row => {
                html += '<tr>';
                tableResult.columns.forEach(col => {
                    const val = row[col];
                    html += `<td>${val !== null && val !== undefined ? val : ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            
            resultsEl.innerHTML = html;
        }
        
        function renderChart(chartResult) {
            const resultsEl = document.getElementById('results');
            document.getElementById('pagination').style.display = 'none';
            
            // Destroy existing chart if any
            if (window.myChart) {
                window.myChart.destroy();
            }
            
            resultsEl.innerHTML = '<canvas id="resultChart"></canvas>';
            const canvas = document.getElementById('resultChart');
            
            const datasets = [];
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#16a085'];
            const isPieChart = chartResult.chartType === 'pie' || chartResult.chartType === 'doughnut';
            
            for (const [seriesName, values] of Object.entries(chartResult.series)) {
                // For pie charts, each data point needs its own color
                if (isPieChart) {
                    const backgroundColors = values.map((_, idx) => colors[idx % colors.length]);
                    datasets.push({
                        label: seriesName,
                        data: values,
                        backgroundColor: backgroundColors,
                        borderColor: '#fff',
                        borderWidth: 2
                    });
                } else {
                    // For bar/line charts, use one color per series
                    datasets.push({
                        label: seriesName,
                        data: values,
                        backgroundColor: colors[datasets.length % colors.length],
                        borderColor: colors[datasets.length % colors.length],
                        borderWidth: 1
                    });
                }
            }
            
            window.myChart = new Chart(canvas, {
                type: chartResult.chartType || 'bar',
                data: {
                    labels: chartResult.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: isPieChart || datasets.length > 1
                        }
                    },
                    scales: !isPieChart ? {
                        y: {
                            beginAtZero: true
                        }
                    } : {}
                }
            });
        }
        
        function renderTimeChart(timeChartResult) {
            const resultsEl = document.getElementById('results');
            document.getElementById('pagination').style.display = 'none';
            
            // Destroy existing chart if any
            if (window.myChart) {
                window.myChart.destroy();
            }
            
            resultsEl.innerHTML = '<div style="margin-bottom: 0.5rem; color: #666; font-size: 0.875rem;">üí° Tip: Click and drag to select a time range. Selection will set the time filter and re-run search without zooming the chart.</div><canvas id="resultChart"></canvas>';
            const canvas = document.getElementById('resultChart');
            
            const datasets = [];
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            let colorIndex = 0;
            
            for (const [seriesName, values] of Object.entries(timeChartResult.series)) {
                datasets.push({
                    label: seriesName,
                    data: values,
                    borderColor: colors[colorIndex % colors.length],
                    backgroundColor: colors[colorIndex % colors.length] + '33',
                    fill: false,
                    tension: 0.1
                });
                colorIndex++;
            }
            
            window.myChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: timeChartResult.timestamps,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: false
                                },
                                pinch: {
                                    enabled: false
                                },
                                drag: {
                                    enabled: true,
                                    backgroundColor: 'rgba(52, 152, 219, 0.3)',
                                    borderColor: 'rgba(52, 152, 219, 0.8)',
                                    borderWidth: 1
                                },
                                mode: 'x',
                                onZoomComplete: ({chart}) => {
                                    // Prevent infinite recursion from resetZoom triggering this again
                                    if (isResettingZoom) {
                                        return false;
                                    }
                                    
                                    // FIRST: Capture the zoom range while it's still available
                                    const xScale = chart.scales.x;
                                    const labels = chart.data.labels;
                                    const minIndex = Math.floor(xScale.min);
                                    const maxIndex = Math.ceil(xScale.max);
                                    
                                    // SECOND: Reset zoom immediately with flag set
                                    isResettingZoom = true;
                                    chart.resetZoom();
                                    isResettingZoom = false;
                                    
                                    // THIRD: Process the captured range
                                    if (minIndex >= 0 && maxIndex < labels.length && minIndex !== maxIndex) {
                                        const startTime = labels[minIndex];
                                        const endTime = labels[maxIndex];
                                        console.log('Zoom detected - minIndex:', minIndex, 'maxIndex:', maxIndex, 'labels.length:', labels.length);
                                        handleTimeRangeSelection(startTime, endTime);
                                    } else {
                                        console.log('Zoom ignored - minIndex:', minIndex, 'maxIndex:', maxIndex, 'labels.length:', labels.length);
                                    }
                                    
                                    return false;
                                }
                            },
                            pan: {
                                enabled: false,
                                mode: 'x'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function handleTimeRangeSelection(startTime, endTime) {
            console.log('Time range selected:', startTime, 'to', endTime);
            
            // Convert timestamp strings to dates
            // The chart labels are ISO strings or formatted timestamps, parse them correctly
            let startDate, endDate;
            
            // Try to parse as ISO string first (most common from backend)
            if (startTime.includes('T') || startTime.includes('Z')) {
                startDate = new Date(startTime);
            } else {
                // If it's a formatted string like "2025-11-13 17:00", treat as UTC
                startDate = new Date(startTime + 'Z');
            }
            
            if (endTime.includes('T') || endTime.includes('Z')) {
                endDate = new Date(endTime);
            } else {
                endDate = new Date(endTime + 'Z');
            }
            
            console.log('Parsed dates - start:', startDate.toISOString(), 'end:', endDate.toISOString());
            
            // Update time range with full ISO format (including milliseconds)
            const fromISO = startDate.toISOString();
            const toISO = endDate.toISOString();
            
            timeFrom.value = fromISO;
            timeTo.value = toISO;
            currentTimeRange.from = fromISO;
            currentTimeRange.to = toISO;
            
            // Update display
            timeRangeDisplay.textContent = `${startDate.toLocaleString()} ‚Üí ${endDate.toLocaleString()}`;
            
            // Show notification and automatically trigger search
            const messageEl = document.getElementById('message');
            messageEl.innerHTML = `<div class="success">üîç Time range selected: ${startDate.toLocaleString()} to ${endDate.toLocaleString()}. Re-running search...</div>`;
            
            // Automatically trigger search
            setTimeout(() => {
                performSearch(0);
            }, 500);
        }
        
        // Search state
        let currentPage = 0;
        let lastSearchParams = null;
        let isResettingZoom = false;
        
        // Perform search
        async function performSearch(page = 0) {
            const indices = document.getElementById('indices').value.split(',').map(s => s.trim()).filter(s => s);
            let query = document.getElementById('query').value.trim();
            const sortField = document.getElementById('sortField').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            const messageEl = document.getElementById('message');
            const resultsEl = document.getElementById('results');
            const resultsCard = document.getElementById('resultsCard');
            
            if (page === 0) {
                messageEl.innerHTML = '';
                resultsEl.innerHTML = '';
                resultsCard.style.display = 'none';
                document.getElementById('facetsCard').style.display = 'none';
                document.getElementById('pagination').style.display = 'none';
            }
            
            if (!query) {
                messageEl.innerHTML = '<div class="error">Please enter a search query</div>';
                return;
            }
            
            if (indices.length === 0) {
                messageEl.innerHTML = '<div class="error">Please enter at least one index</div>';
                return;
            }
            
            // Prepare timestamp range for API request (sent as separate fields, not in query string)
            let timestampFrom = null;
            let timestampTo = null;
            
            if (currentTimeRange.from || currentTimeRange.to) {
                // Parse ISO timestamps (already in UTC format with milliseconds)
                timestampFrom = currentTimeRange.from ? new Date(currentTimeRange.from).getTime() : null;
                timestampTo = currentTimeRange.to ? new Date(currentTimeRange.to).getTime() : null;
                
                console.log('Adding time filter - from:', timestampFrom, timestampFrom ? '(' + new Date(timestampFrom).toISOString() + ')' : '', 'to:', timestampTo, timestampTo ? '(' + new Date(timestampTo).toISOString() + ')' : '');
                console.log('Original time range values - from:', currentTimeRange.from, 'to:', currentTimeRange.to);
            }
            
            // Save search params
            lastSearchParams = { indices, query, sortField, sortOrder };
            currentPage = page;
            
            messageEl.innerHTML = '<div class="loading">Searching...</div>';
            
            try {
                const requestBody = {
                    indices: indices,
                    query: query,
                    page: page,
                    pageSize: 50,
                    sortField: sortField,
                    sortDescending: sortOrder === 'desc',
                    includeFacets: true
                };
                
                // Add timestamp range if specified
                if (timestampFrom !== null) {
                    requestBody.timestampFrom = timestampFrom;
                }
                if (timestampTo !== null) {
                    requestBody.timestampTo = timestampTo;
                }
                
                // Add facet buckets if specified
                if (Object.keys(facetBuckets).length > 0) {
                    requestBody.facetBuckets = facetBuckets;
                }
                
                console.log('Search request:', requestBody);
                
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || 'Search failed');
                }
                
                const data = await response.json();
                
                if (page === 0) {
                    addToHistory(document.getElementById('query').value, indices.join(', '));
                }
                
                resultsCard.style.display = 'block';
                
                // Check result type and render accordingly
                if (data.resultType === 'TABLE') {
                    const sourceHits = data.pipeResult.sourceHits || 0;
                    messageEl.innerHTML = `<div class="success">Table result (${sourceHits} source hits)</div>`;
                    document.getElementById('totalHits').textContent = sourceHits > 0 ? `${sourceHits} source hits` : 'Table';
                    renderTable(data.pipeResult);
                    setExportData(data.pipeResult, 'TABLE');
                } else if (data.resultType === 'CHART') {
                    const sourceHits = data.pipeResult.sourceHits || 0;
                    messageEl.innerHTML = `<div class="success">Chart result (${sourceHits} source hits)</div>`;
                    document.getElementById('totalHits').textContent = sourceHits > 0 ? `${sourceHits} source hits` : 'Chart';
                    renderChart(data.pipeResult);
                    setExportData(data.pipeResult, 'CHART');
                } else if (data.resultType === 'TIMECHART') {
                    const sourceHits = data.pipeResult.sourceHits || 0;
                    messageEl.innerHTML = `<div class="success">Time chart result (${sourceHits} source hits)</div>`;
                    document.getElementById('totalHits').textContent = sourceHits > 0 ? `${sourceHits} source hits` : 'Time Chart';
                    renderTimeChart(data.pipeResult);
                    setExportData(data.pipeResult, 'TIMECHART');
                } else if (data.results && data.results.length > 0) {
                    // Regular log results
                    messageEl.innerHTML = `<div class="success">Found ${data.totalHits} results</div>`;
                    document.getElementById('totalHits').textContent = data.totalHits;
                    
                    // Render facets from server
                    if (data.facets) {
                        renderFacets(data.facets, data.facetSampleSize, data.totalHits);
                    }
                    
                    // Render results
                    resultsEl.innerHTML = '';
                    data.results.forEach(result => {
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'result-item';
                        
                        const timestamp = result.timestamp ? new Date(result.timestamp).toLocaleString() : 'N/A';
                        const timestampISO = result.timestamp || null;
                        
                        // Parse raw text and make key=value pairs clickable
                        let processedText = result.rawText || '';
                        if (result.fields && Object.keys(result.fields).length > 0) {
                            // Sort by length descending to avoid partial matches
                            const sortedFields = Object.entries(result.fields).sort((a, b) => b[0].length - a[0].length);
                            
                            for (const [key, value] of sortedFields) {
                                // Escape special regex characters in key and value
                                const escapeRegex = (str) => str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                                const keyEscaped = escapeRegex(key);
                                const valueEscaped = escapeRegex(value);
                                
                                // Match key=value or key:value patterns
                                const regex = new RegExp(`(${keyEscaped}[:=])(${valueEscaped})`, 'g');
                                processedText = processedText.replace(regex, 
                                    `$1<span class="field-tag-inline" data-field="${key}" data-value="${value}" title="Click to add ${key}:${value} to query">$2</span>`);
                            }
                        }
                        
                        const timestampHtml = timestampISO 
                            ? `<span class="timestamp-clickable" data-timestamp="${timestampISO}" title="Click to refine search by time">${timestamp}</span>`
                            : timestamp;
                        
                        resultDiv.innerHTML = `
                            <div class="result-meta">
                                <strong>Time:</strong> ${timestampHtml} | 
                                <strong>Index:</strong> ${result.indexName} | 
                                <strong>Score:</strong> ${result.score.toFixed(2)}
                            </div>
                            <div class="result-text">${processedText}</div>
                        `;
                        
                        resultsEl.appendChild(resultDiv);
                    });
                    
                    // Add click handlers to inline field tags
                    document.querySelectorAll('.field-tag-inline').forEach(tag => {
                        tag.addEventListener('click', (e) => {
                            e.preventDefault();
                            addConstraint(tag.dataset.field, tag.dataset.value);
                        });
                    });
                    
                    // Add click handlers to timestamps
                    document.querySelectorAll('.timestamp-clickable').forEach(ts => {
                        ts.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const timestamp = ts.dataset.timestamp;
                            showTimeRefinementPopup(timestamp, e.pageX, e.pageY);
                        });
                    });
                    
                    // Update pagination
                    if (data.totalPages > 1) {
                        document.getElementById('pagination').style.display = 'flex';
                        document.getElementById('currentPage').textContent = data.page + 1;
                        document.getElementById('totalPages').textContent = data.totalPages;
                        document.getElementById('prevPage').disabled = data.page === 0;
                        document.getElementById('nextPage').disabled = data.page >= data.totalPages - 1;
                    } else {
                        document.getElementById('pagination').style.display = 'none';
                    }
                    
                    // Set export data for logs
                    setExportData(data.results, 'LOGS');
                } else {
                    messageEl.innerHTML = '<div class="success">No results found</div>';
                }
                
            } catch (error) {
                messageEl.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        // Search form
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            performSearch(0);
        });
        
        // Pagination handlers
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 0) {
                performSearch(currentPage - 1);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
        
        document.getElementById('nextPage').addEventListener('click', () => {
            performSearch(currentPage + 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        // Sort change handlers
        document.getElementById('sortField').addEventListener('change', () => {
            if (lastSearchParams) {
                performSearch(0);
            }
        });
        
        document.getElementById('sortOrder').addEventListener('change', () => {
            if (lastSearchParams) {
                performSearch(0);
            }
        });
        
        // Share Query Modal
        const shareModal = document.getElementById('shareModal');
        const shareBtn = document.getElementById('shareBtn');
        const shareModalClose = document.getElementById('shareModalClose');
        
        shareBtn.addEventListener('click', () => {
            generateShareLinks();
            shareModal.style.display = 'block';
        });
        
        shareModalClose.addEventListener('click', () => {
            shareModal.style.display = 'none';
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === shareModal) {
                shareModal.style.display = 'none';
            }
        });
        
        function generateShareLinks() {
            const indices = document.getElementById('indices').value;
            const query = document.getElementById('query').value;
            const sortField = document.getElementById('sortField').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            // Generate URL
            const params = new URLSearchParams();
            params.append('q', query);
            params.append('indices', indices);
            if (currentTimeRange.from) params.append('from', currentTimeRange.from);
            if (currentTimeRange.to) params.append('to', currentTimeRange.to);
            if (sortField !== 'timestamp') params.append('sort', sortField);
            if (sortOrder !== 'desc') params.append('order', sortOrder);
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            document.getElementById('shareUrl').textContent = shareUrl;
            
            // Generate curl command
            const apiUrl = `${window.location.origin}/api/search`;
            const curlBody = {
                indices: indices.split(',').map(s => s.trim()).filter(s => s),
                query: query,
                page: 0,
                pageSize: 50,
                sortField: sortField,
                sortDescending: sortOrder === 'desc',
                includeFacets: true
            };
            
            // Add timestamp filters if present
            if (currentTimeRange.from) {
                curlBody.timestampFrom = new Date(currentTimeRange.from + ':00Z').getTime();
            }
            if (currentTimeRange.to) {
                curlBody.timestampTo = new Date(currentTimeRange.to + ':00Z').getTime();
            }
            
            // Add facet buckets if present
            if (Object.keys(facetBuckets).length > 0) {
                curlBody.facetBuckets = facetBuckets;
            }
            
            const curlCmd = `curl -X POST '${apiUrl}' \\
  -H 'Content-Type: application/json' \\
  -d '${JSON.stringify(curlBody, null, 2).replace(/'/g, "'\\''")}' \\
  | jq`;
            
            document.getElementById('shareCurl').textContent = curlCmd;
        }
        
        // Copy to clipboard
        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const type = btn.dataset.copy;
                const text = type === 'url' 
                    ? document.getElementById('shareUrl').textContent
                    : document.getElementById('shareCurl').textContent;
                
                navigator.clipboard.writeText(text).then(() => {
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    alert('Failed to copy: ' + err);
                });
            });
        });
        
        
        // Export functionality
        let currentExportData = null;
        let currentResultType = null;
        
        document.getElementById('exportBtn').addEventListener('click', () => {
            const exportOptions = document.getElementById('exportOptions');
            exportOptions.style.display = exportOptions.style.display === 'none' ? 'block' : 'none';
        });
        
        function setExportData(data, resultType) {
            currentExportData = data;
            currentResultType = resultType;
            
            // Enable/disable PDF button based on result type
            const pdfBtn = document.getElementById('exportPdf');
            if (resultType === 'CHART' || resultType === 'TIMECHART') {
                pdfBtn.disabled = false;
                pdfBtn.style.opacity = '1';
                pdfBtn.style.cursor = 'pointer';
            } else {
                pdfBtn.disabled = true;
                pdfBtn.style.opacity = '0.5';
                pdfBtn.style.cursor = 'not-allowed';
            }
        }
        
        document.getElementById('exportCsv').addEventListener('click', () => exportToCsv());
        document.getElementById('exportJson').addEventListener('click', () => exportToJson());
        document.getElementById('exportPdf').addEventListener('click', () => exportToPdf());
        
        function exportToCsv() {
            if (!currentExportData) return;
            
            let csv = '';
            
            if (currentResultType === 'TABLE') {
                // Export table results
                const columns = currentExportData.columns;
                csv = columns.join(',') + '\n';
                currentExportData.rows.forEach(row => {
                    const values = columns.map(col => {
                        const val = row[col];
                        return typeof val === 'string' && val.includes(',') ? `"${val}"` : val;
                    });
                    csv += values.join(',') + '\n';
                });
            } else if (currentResultType === 'LOGS') {
                // Export log results
                csv = 'timestamp,index,score,rawText,fields\n';
                currentExportData.forEach(result => {
                    const timestamp = result.timestamp || '';
                    const index = result.indexName || '';
                    const score = result.score || '';
                    const rawText = (result.rawText || '').replace(/"/g, '""');
                    const fields = JSON.stringify(result.fields || {}).replace(/"/g, '""');
                    csv += `"${timestamp}","${index}",${score},"${rawText}","${fields}"\n`;
                });
            }
            
            downloadFile(csv, 'search-results.csv', 'text/csv');
        }
        
        function exportToJson() {
            if (!currentExportData) return;
            
            const jsonData = {
                query: document.getElementById('query').value,
                indices: document.getElementById('indices').value,
                timestamp: new Date().toISOString(),
                resultType: currentResultType,
                data: currentExportData
            };
            
            downloadFile(JSON.stringify(jsonData, null, 2), 'search-results.json', 'application/json');
        }
        
        function exportToPdf() {
            if (!currentExportData || (currentResultType !== 'CHART' && currentResultType !== 'TIMECHART')) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add header
            doc.setFontSize(16);
            doc.text('Log Search Results', 15, 15);
            
            doc.setFontSize(10);
            doc.text(`Query: ${document.getElementById('query').value}`, 15, 25);
            doc.text(`Indices: ${document.getElementById('indices').value}`, 15, 32);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 15, 39);
            
            if (currentExportData.sourceHits) {
                doc.text(`Source Hits: ${currentExportData.sourceHits}`, 15, 46);
            }
            
            // Add chart as image
            const canvas = document.getElementById('resultChart');
            if (canvas) {
                const imgData = canvas.toDataURL('image/png');
                doc.addImage(imgData, 'PNG', 15, 55, 180, 100);
            }
            
            doc.save('search-results.pdf');
        }
        
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Parse URL parameters on load
        function parseUrlParameters() {
            const params = new URLSearchParams(window.location.search);
            
            if (params.has('q')) {
                document.getElementById('query').value = params.get('q');
            }
            if (params.has('indices')) {
                document.getElementById('indices').value = params.get('indices');
            }
            if (params.has('from')) {
                const fromVal = params.get('from');
                timeFrom.value = fromVal;
                currentTimeRange.from = fromVal;
            }
            if (params.has('to')) {
                const toVal = params.get('to');
                timeTo.value = toVal;
                currentTimeRange.to = toVal;
            }
            if (currentTimeRange.from || currentTimeRange.to) {
                const fromStr = currentTimeRange.from ? new Date(currentTimeRange.from).toLocaleString() : 'Start';
                const toStr = currentTimeRange.to ? new Date(currentTimeRange.to).toLocaleString() : 'End';
                timeRangeDisplay.textContent = `${fromStr} ‚Üí ${toStr}`;
            }
            if (params.has('sort')) {
                document.getElementById('sortField').value = params.get('sort');
            }
            if (params.has('order')) {
                document.getElementById('sortOrder').value = params.get('order');
            }
            
            // Auto-search if query present
            if (params.has('q')) {
                performSearch(0);
            }
        }
        
        // Initialize
        renderHistory();
        parseUrlParameters();
        
        // Set random example as placeholder
        window.addEventListener('load', () => {
            const examples = [
                'level:ERROR',
                'status:slow',
                'user:admin',
                '(level:ERROR OR level:WARN) AND user:admin'
            ];
            
            document.getElementById('query').placeholder = examples[Math.floor(Math.random() * examples.length)];
        });
        
        // Time refinement popup event listeners
        document.querySelectorAll('.time-popup-option[data-action]').forEach(option => {
            option.addEventListener('click', () => {
                const action = option.dataset.action;
                const amount = option.dataset.amount;
                const unit = option.dataset.unit;
                
                if (amount && unit) {
                    applyTimeRefinement(action, parseInt(amount), unit);
                } else {
                    applyTimeRefinement(action);
                }
            });
        });
        
        // Custom time refinement buttons
        document.getElementById('customBefore').addEventListener('click', () => {
            const amount = document.getElementById('customTimeAmount').value;
            const unit = document.getElementById('customTimeUnit').value;
            if (amount && parseInt(amount) > 0) {
                applyTimeRefinement('before-custom', parseInt(amount), unit);
            }
        });
        
        document.getElementById('customAfter').addEventListener('click', () => {
            const amount = document.getElementById('customTimeAmount').value;
            const unit = document.getElementById('customTimeUnit').value;
            if (amount && parseInt(amount) > 0) {
                applyTimeRefinement('after-custom', parseInt(amount), unit);
            }
        });
        
        document.getElementById('customAround').addEventListener('click', () => {
            const amount = document.getElementById('customTimeAmount').value;
            const unit = document.getElementById('customTimeUnit').value;
            if (amount && parseInt(amount) > 0) {
                applyTimeRefinement('around-custom', parseInt(amount), unit);
            }
        });
        
        // Close popup when clicking outside
        document.addEventListener('click', (e) => {
            const popup = document.getElementById('timeRefinementPopup');
            const isClickInside = popup.contains(e.target) || e.target.classList.contains('timestamp-clickable');
            if (!isClickInside) {
                hideTimeRefinementPopup();
            }
        });
        
        // Prevent popup from closing when clicking inside it
        document.getElementById('timeRefinementPopup').addEventListener('click', (e) => {
            e.stopPropagation();
        });
    </script>
</body>
</html>
