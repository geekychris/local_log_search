<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Query - Little Log Peep</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #3c3c3c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-logo {
            height: 50px;
            width: auto;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-links a {
            color: #d4d4d4;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background 0.2s;
            font-size: 14px;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.1);
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .connection-info {
            display: flex;
            gap: 20px;
            align-items: center;
            padding: 10px;
            background: #2d2d2d;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 13px;
        }

        .connection-info .status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connection-info .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ec9b0;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .sidebar {
            background: #252526;
            border-radius: 8px;
            padding: 15px;
            height: fit-content;
        }

        .sidebar h3 {
            font-size: 14px;
            margin-bottom: 15px;
            color: #cccccc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tables-list {
            list-style: none;
        }

        .table-item {
            padding: 8px 10px;
            margin-bottom: 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
        }

        .table-item:hover {
            background: #2a2d2e;
        }

        .table-item.active {
            background: #094771;
        }

        .query-section {
            background: #252526;
            border-radius: 8px;
            padding: 20px;
        }

        .query-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid #3c3c3c;
        }

        .query-tab {
            padding: 8px 16px;
            background: none;
            border: none;
            color: #969696;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .query-tab:hover {
            color: #d4d4d4;
        }

        .query-tab.active {
            color: #ffffff;
            border-bottom-color: #007acc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        textarea, input[type="text"] {
            width: 100%;
            background: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }

        textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: #007acc;
        }

        #queryInput {
            min-height: 150px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: #cccccc;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 10px 20px;
            background: #0e639c;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover {
            background: #1177bb;
        }

        button.secondary {
            background: #3c3c3c;
        }

        button.secondary:hover {
            background: #4c4c4c;
        }

        button:disabled {
            background: #2d2d2d;
            color: #666666;
            cursor: not-allowed;
        }

        .results-section {
            background: #252526;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .results-header h3 {
            font-size: 16px;
            color: #ffffff;
        }

        .results-meta {
            font-size: 13px;
            color: #858585;
        }

        .results-table-container {
            overflow-x: auto;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #1e1e1e;
        }

        th {
            background: #2d2d2d;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 2px solid #3c3c3c;
            position: sticky;
            top: 0;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #2d2d2d;
            font-size: 13px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        tr:hover {
            background: #2a2d2e;
        }

        .error-message {
            padding: 15px;
            background: #5a1d1d;
            border-left: 4px solid #f48771;
            border-radius: 4px;
            color: #f48771;
            font-size: 13px;
        }

        .success-message {
            padding: 15px;
            background: #1a3d1a;
            border-left: 4px solid #4ec9b0;
            border-radius: 4px;
            color: #4ec9b0;
            font-size: 13px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #858585;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .quick-queries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .quick-query-btn {
            padding: 8px 12px;
            text-align: left;
            font-size: 12px;
            background: #2d2d2d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .column-list {
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .column-item {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .column-item input[type="text"] {
            flex: 1;
        }

        .column-item select {
            background: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 8px;
        }

        .add-column-btn {
            padding: 6px 12px;
            font-size: 12px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <img src="LLP_Logo.png" alt="Little Log Peep" class="header-logo">
            </div>
            <div class="nav-links">
                <a href="/ui/index.html">üîç Search</a>
                <a href="/ui/sources.html">üìÅ Log Sources</a>
            </div>
        </header>
        
        <div class="connection-info">
            <div class="status">
                <span class="status-dot"></span>
                <span>Connected to H2 Database</span>
            </div>
            <div>JDBC URL: jdbc:h2:file:~/.local_log_search/database/logdb</div>
        </div>

        <div class="main-grid">
            <aside class="sidebar">
                <h3>Tables</h3>
                <button onclick="loadTables()" class="secondary" style="width: 100%; margin-bottom: 10px;">
                    Refresh
                </button>
                <ul class="tables-list" id="tablesList">
                    <li class="table-item">Loading...</li>
                </ul>
            </aside>

            <main>
                <div class="query-section">
                    <div class="query-tabs">
                        <button class="query-tab active" onclick="switchTab('query')">Query</button>
                        <button class="query-tab" onclick="switchTab('create')">Create Table</button>
                        <button class="query-tab" onclick="switchTab('insert')">Insert Data</button>
                    </div>

                    <!-- Query Tab -->
                    <div id="queryTab" class="tab-content active">
                        <div class="form-group">
                            <label for="queryInput">SQL Query</label>
                            <textarea id="queryInput" placeholder="SELECT * FROM exported_tables;"></textarea>
                        </div>
                        <div class="button-group">
                            <button onclick="executeQuery()" id="executeBtn">Execute Query</button>
                            <button class="secondary" onclick="clearQuery()">Clear</button>
                            <button class="secondary" onclick="formatQuery()">Format</button>
                        </div>
                        <div class="quick-queries">
                            <button class="quick-query-btn" onclick="setQuery('SELECT * FROM exported_tables;')">
                                List All Tables
                            </button>
                            <button class="quick-query-btn" onclick="setQuery('SELECT table_name, row_count, created_at FROM exported_tables ORDER BY created_at DESC;')">
                                Recent Tables
                            </button>
                            <button class="quick-query-btn" onclick="setQuery('SELECT * FROM table_columns;')">
                                Show Columns
                            </button>
                        </div>
                    </div>

                    <!-- Create Table Tab -->
                    <div id="createTab" class="tab-content">
                        <div class="form-group">
                            <label for="createTableName">Table Name</label>
                            <input type="text" id="createTableName" placeholder="my_custom_table">
                        </div>
                        <div class="form-group">
                            <label>Columns</label>
                            <div class="column-list" id="columnsList">
                                <div class="column-item">
                                    <input type="text" placeholder="Column name" value="id">
                                    <select>
                                        <option value="BIGINT">BIGINT</option>
                                        <option value="VARCHAR(255)">VARCHAR(255)</option>
                                        <option value="VARCHAR(4000)">VARCHAR(4000)</option>
                                        <option value="TIMESTAMP">TIMESTAMP</option>
                                        <option value="INTEGER">INTEGER</option>
                                        <option value="BOOLEAN">BOOLEAN</option>
                                        <option value="DOUBLE">DOUBLE</option>
                                    </select>
                                    <button class="secondary" onclick="removeColumn(this)" style="padding: 8px 12px;">√ó</button>
                                </div>
                            </div>
                            <button class="secondary add-column-btn" onclick="addColumn()">+ Add Column</button>
                        </div>
                        <div class="button-group">
                            <button onclick="createTable()">Create Table</button>
                            <button class="secondary" onclick="previewCreateSQL()">Preview SQL</button>
                        </div>
                    </div>

                    <!-- Insert Tab -->
                    <div id="insertTab" class="tab-content">
                        <div class="form-group">
                            <label for="insertTableName">Table Name</label>
                            <input type="text" id="insertTableName" placeholder="my_custom_table">
                        </div>
                        <div class="form-group">
                            <label for="insertSQL">INSERT Statement or Values</label>
                            <textarea id="insertSQL" placeholder="INSERT INTO my_table (col1, col2) VALUES ('value1', 'value2');"></textarea>
                        </div>
                        <div class="button-group">
                            <button onclick="insertData()">Execute Insert</button>
                            <button class="secondary" onclick="document.getElementById('insertSQL').value = ''">Clear</button>
                        </div>
                    </div>
                </div>

                <div class="results-section" id="resultsSection" style="display: none;">
                    <div class="results-header">
                        <h3>Results</h3>
                        <div class="results-meta" id="resultsMeta"></div>
                    </div>
                    <div id="resultsContent"></div>
                </div>
            </main>
        </div>
    </div>

    <script>
        let currentTab = 'query';

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadTables();
        });

        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.query-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        async function loadTables() {
            try {
                const response = await fetch('/api/sql/tables');
                if (!response.ok) throw new Error('Failed to load tables');
                
                const tables = await response.json();
                const tablesList = document.getElementById('tablesList');
                
                if (tables.length === 0) {
                    tablesList.innerHTML = '<li class="table-item" style="color: #858585;">No tables found</li>';
                    return;
                }
                
                tablesList.innerHTML = tables.map(table => `
                    <li class="table-item" onclick="selectTable('${table.tableName}')">
                        ${table.tableName}
                        <div style="font-size: 11px; color: #858585; margin-top: 2px;">
                            ${table.rowCount} rows
                        </div>
                    </li>
                `).join('');
            } catch (error) {
                console.error('Error loading tables:', error);
                document.getElementById('tablesList').innerHTML = 
                    '<li class="table-item" style="color: #f48771;">Error loading tables</li>';
            }
        }

        function selectTable(tableName) {
            document.querySelectorAll('.table-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            setQuery(`SELECT * FROM ${tableName} LIMIT 100;`);
        }

        function setQuery(query) {
            if (currentTab !== 'query') {
                switchTab('query');
                document.querySelector('.query-tab').click();
            }
            document.getElementById('queryInput').value = query;
        }

        function clearQuery() {
            document.getElementById('queryInput').value = '';
        }

        function formatQuery() {
            const input = document.getElementById('queryInput');
            const query = input.value;
            
            // Basic SQL formatting
            const formatted = query
                .replace(/\s+/g, ' ')
                .replace(/\s*,\s*/g, ', ')
                .replace(/\s*\(/g, ' (')
                .replace(/\s*\)/g, ')')
                .replace(/\bSELECT\b/gi, 'SELECT\n  ')
                .replace(/\bFROM\b/gi, '\nFROM\n  ')
                .replace(/\bWHERE\b/gi, '\nWHERE\n  ')
                .replace(/\bORDER BY\b/gi, '\nORDER BY\n  ')
                .replace(/\bGROUP BY\b/gi, '\nGROUP BY\n  ')
                .replace(/\bLIMIT\b/gi, '\nLIMIT ')
                .trim();
            
            input.value = formatted;
        }

        async function executeQuery() {
            let query = document.getElementById('queryInput').value.trim();
            
            if (!query) {
                showError('Please enter a SQL query');
                return;
            }
            
            // Auto-add LIMIT if it's a SELECT without LIMIT
            const upperQuery = query.toUpperCase();
            if (upperQuery.startsWith('SELECT') && !upperQuery.includes('LIMIT')) {
                const autoLimit = 1000;
                query = query + ` LIMIT ${autoLimit}`;
                showWarning(`‚ö†Ô∏è Auto-added LIMIT ${autoLimit} to prevent browser freeze. Add your own LIMIT to override.`);
            }
            
            const executeBtn = document.getElementById('executeBtn');
            executeBtn.disabled = true;
            executeBtn.textContent = 'Executing...';
            
            try {
                const response = await fetch('/api/sql/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ sql: query })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Query failed');
                }
                
                const result = await response.json();
                displayResults(query, result);
                
            } catch (error) {
                showError(`Error executing query: ${error.message}`);
            } finally {
                executeBtn.disabled = false;
                executeBtn.textContent = 'Execute Query';
            }
        }

        function displayResults(query, result) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');
            const resultsMeta = document.getElementById('resultsMeta');
            
            resultsSection.style.display = 'block';
            
            // Handle SELECT queries
            if (result.type === 'SELECT') {
                let warningHtml = '';
                
                // Warn about large result sets
                if (result.rowCount >= 1000) {
                    warningHtml = '<div style="padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; color: #856404; font-size: 13px; margin-bottom: 15px;">‚ö†Ô∏è Large result set (' + result.rowCount + ' rows). Consider adding WHERE clause or smaller LIMIT.</div>';
                }
                
                resultsMeta.textContent = `${result.rowCount} rows returned`;
                
                if (result.rowCount === 0) {
                    resultsContent.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div>No results</div></div>';
                    return;
                }
                
                // Build HTML table
                let html = warningHtml + '<div class="results-table-container"><table>';
                
                // Headers
                html += '<thead><tr>';
                result.columns.forEach(col => {
                    html += `<th>${col.name}</th>`;
                });
                html += '</tr></thead>';
                
                // Rows
                html += '<tbody>';
                result.rows.forEach(row => {
                    html += '<tr>';
                    result.columns.forEach(col => {
                        const value = row[col.name];
                        html += `<td>${value !== null && value !== undefined ? value : '<em>null</em>'}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
                
                resultsContent.innerHTML = html;
            }
            // Handle INSERT/UPDATE/DELETE/CREATE queries
            else if (result.success) {
                let message = result.message;
                if (result.rowsAffected !== undefined) {
                    message += ` (${result.rowsAffected} rows affected)`;
                }
                showSuccess(message);
                loadTables(); // Refresh tables list
            } else {
                resultsContent.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úì</div><div>Query executed</div></div>';
                resultsMeta.textContent = '';
            }
        }

        function showError(message) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');
            const resultsMeta = document.getElementById('resultsMeta');
            
            resultsSection.style.display = 'block';
            resultsContent.innerHTML = `<div class="error-message">${message}</div>`;
            resultsMeta.textContent = '';
        }

        function showSuccess(message) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');
            const resultsMeta = document.getElementById('resultsMeta');
            
            resultsSection.style.display = 'block';
            resultsContent.innerHTML = `<div class="success-message">${message}</div>`;
            resultsMeta.textContent = '';
        }
        
        function showWarning(message) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');
            const resultsMeta = document.getElementById('resultsMeta');
            
            resultsSection.style.display = 'block';
            resultsContent.innerHTML = `<div style="padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; color: #856404; font-size: 13px; margin-bottom: 15px;">${message}</div>`;
            resultsMeta.textContent = '';
        }

        function addColumn() {
            const columnsList = document.getElementById('columnsList');
            const columnItem = document.createElement('div');
            columnItem.className = 'column-item';
            columnItem.innerHTML = `
                <input type="text" placeholder="Column name">
                <select>
                    <option value="BIGINT">BIGINT</option>
                    <option value="VARCHAR(255)" selected>VARCHAR(255)</option>
                    <option value="VARCHAR(4000)">VARCHAR(4000)</option>
                    <option value="TIMESTAMP">TIMESTAMP</option>
                    <option value="INTEGER">INTEGER</option>
                    <option value="BOOLEAN">BOOLEAN</option>
                    <option value="DOUBLE">DOUBLE</option>
                </select>
                <button class="secondary" onclick="removeColumn(this)" style="padding: 8px 12px;">√ó</button>
            `;
            columnsList.appendChild(columnItem);
        }

        function removeColumn(btn) {
            btn.parentElement.remove();
        }

        function previewCreateSQL() {
            const tableName = document.getElementById('createTableName').value.trim();
            const columns = Array.from(document.querySelectorAll('#columnsList .column-item')).map(item => {
                const name = item.querySelector('input').value.trim();
                const type = item.querySelector('select').value;
                return name ? `  ${name} ${type}` : null;
            }).filter(Boolean);
            
            if (!tableName || columns.length === 0) {
                showError('Please provide table name and at least one column');
                return;
            }
            
            const sql = `CREATE TABLE ${tableName} (\n${columns.join(',\n')}\n);`;
            setQuery(sql);
            
            // Switch to query tab
            document.querySelectorAll('.query-tab')[0].click();
        }

        async function createTable() {
            const tableName = document.getElementById('createTableName').value.trim();
            const columns = Array.from(document.querySelectorAll('#columnsList .column-item')).map(item => {
                const name = item.querySelector('input').value.trim();
                const type = item.querySelector('select').value;
                return name ? `${name} ${type}` : null;
            }).filter(Boolean);
            
            if (!tableName || columns.length === 0) {
                showError('Please provide table name and at least one column');
                return;
            }
            
            const sql = `CREATE TABLE ${tableName} (${columns.join(', ')});`;
            
            try {
                const response = await fetch('/api/sql/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ sql: sql })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create table');
                }
                
                showSuccess(`Table '${tableName}' created successfully`);
                loadTables();
                
                // Clear form
                document.getElementById('createTableName').value = '';
                document.getElementById('columnsList').innerHTML = `
                    <div class="column-item">
                        <input type="text" placeholder="Column name" value="id">
                        <select>
                            <option value="BIGINT">BIGINT</option>
                            <option value="VARCHAR(255)">VARCHAR(255)</option>
                            <option value="VARCHAR(4000)">VARCHAR(4000)</option>
                            <option value="TIMESTAMP">TIMESTAMP</option>
                            <option value="INTEGER">INTEGER</option>
                            <option value="BOOLEAN">BOOLEAN</option>
                            <option value="DOUBLE">DOUBLE</option>
                        </select>
                        <button class="secondary" onclick="removeColumn(this)" style="padding: 8px 12px;">√ó</button>
                    </div>
                `;
                
            } catch (error) {
                showError(`Error creating table: ${error.message}`);
            }
        }

        async function insertData() {
            const sql = document.getElementById('insertSQL').value.trim();
            
            if (!sql) {
                showError('Please enter an INSERT statement');
                return;
            }
            
            try {
                const response = await fetch('/api/sql/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ sql: sql })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to insert data');
                }
                
                showSuccess('Data inserted successfully');
                document.getElementById('insertSQL').value = '';
                
            } catch (error) {
                showError(`Error inserting data: ${error.message}`);
            }
        }
    </script>
</body>
</html>
