<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Log Search</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîç</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 1.5rem;
            font-weight: 500;
        }
        .nav-links {
            display: flex;
            gap: 1rem;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .nav-links a:hover {
            background: rgba(255,255,255,0.1);
        }
        .nav-links a.active {
            background: rgba(255,255,255,0.2);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: #2c3e50;
        }
        .two-col {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 1.5rem;
        }
        @media (max-width: 1024px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }
        .form-group {
            margin-bottom: 1rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }
        input[type="text"], input[type="date"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        input[type="text"]:focus, input[type="date"]:focus {
            outline: none;
            border-color: #3498db;
        }
        .date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: #2980b9;
        }
        button:active {
            background: #21618c;
        }
        button.secondary {
            background: #95a5a6;
        }
        button.secondary:hover {
            background: #7f8c8d;
        }
        .button-group {
            display: flex;
            gap: 0.5rem;
        }
        .results {
            margin-top: 1.5rem;
        }
        .result-item {
            background: #f8f9fa;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }
        .result-meta {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        .result-text {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            color: #2c3e50;
            word-wrap: break-word;
        }
        .result-fields {
            margin-top: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .field-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .field-tag:hover {
            background: #1976d2;
            color: white;
            transform: translateY(-1px);
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        .sidebar {
            position: sticky;
            top: 2rem;
        }
        .history-item {
            background: #f8f9fa;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .history-item:hover {
            background: #e9ecef;
        }
        .history-query {
            font-family: monospace;
            color: #2c3e50;
        }
        .history-time {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
        }
        .facet-list {
            list-style: none;
        }
        .facet-item {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .facet-item:hover {
            background: #f8f9fa;
            cursor: pointer;
        }
        .facet-count {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .example-query {
            background: #f8f9fa;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }
        .example-query-text {
            font-family: monospace;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }
        .example-description {
            font-size: 0.875rem;
            color: #666;
        }
        .example-query:hover {
            background: #e9ecef;
            cursor: pointer;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .query-hint {
            font-size: 0.875rem;
            color: #666;
            margin-top: 0.25rem;
        }
        .clear-btn {
            background: #e74c3c;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }
        .clear-btn:hover {
            background: #c0392b;
        }
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 1rem 0;
        }
        .pagination button {
            padding: 0.5rem 1rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .pagination button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .pagination button:hover:not(:disabled) {
            background: #2980b9;
        }
        .pagination .page-info {
            color: #666;
            font-size: 0.875rem;
        }
        .sort-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            align-items: center;
        }
        .sort-controls label {
            font-size: 0.875rem;
            color: #666;
        }
        .sort-controls select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .results-table th {
            background: #3498db;
            color: white;
            padding: 0.75rem;
            text-align: left;
            border: 1px solid #ddd;
            font-weight: 500;
        }
        .results-table td {
            padding: 0.5rem 0.75rem;
            border: 1px solid #ddd;
        }
        .results-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .results-table tr:hover {
            background: #e3f2fd;
        }
        #resultChart {
            max-height: 500px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Local Log Search</h1>
        <div class="nav-links">
            <a href="#" class="nav-link active" data-page="search">Search</a>
            <a href="#" class="nav-link" data-page="examples">Query Examples</a>
        </div>
    </div>
    
    <div class="container">
        <!-- Search Page -->
        <div id="search" class="page active">
            <div class="two-col">
                <div>
                    <div class="card">
                        <h2>Search Logs</h2>
                        <form id="searchForm">
                            <div class="form-group">
                                <label for="indices">Indices (comma-separated)</label>
                                <input type="text" id="indices" placeholder="app-logs, access-logs" value="app-logs">
                            </div>
                            <div class="form-group">
                                <label for="query">Query</label>
                                <input type="text" id="query" placeholder="level:ERROR | stats count by user" value="">
                                <div class="query-hint">
                                    Use field:value for exact matches, field:[min TO max] for ranges. Pipe commands (|) enable aggregations: | stats, | chart, | timechart. See Query Examples for details.
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Date Range (optional)</label>
                                <div class="date-range">
                                    <input type="date" id="dateFrom" placeholder="From">
                                    <input type="date" id="dateTo" placeholder="To">
                                </div>
                            </div>
                            <div class="button-group">
                                <button type="submit">Search</button>
                                <button type="button" class="secondary" id="clearBtn">Clear</button>
                            </div>
                        </form>
                        
                        <div id="message"></div>
                    </div>
                    
                    <div class="card" id="resultsCard" style="display:none;">
                        <h2>Results (<span id="totalHits">0</span> hits)</h2>
                        <div class="sort-controls">
                            <label for="sortField">Sort by:</label>
                            <select id="sortField">
                                <option value="score">Relevance</option>
                                <option value="timestamp" selected>Timestamp</option>
                                <option value="level">Level</option>
                                <option value="user">User</option>
                                <option value="operation">Operation</option>
                                <option value="status">Status</option>
                            </select>
                            <select id="sortOrder">
                                <option value="desc" selected>Descending</option>
                                <option value="asc">Ascending</option>
                            </select>
                        </div>
                        <div class="results" id="results"></div>
                        <div class="pagination" id="pagination" style="display:none;">
                            <button id="prevPage">‚Üê Previous</button>
                            <span class="page-info">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
                            <button id="nextPage">Next ‚Üí</button>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar">
                    <div class="card">
                        <h2>Search History</h2>
                        <button class="clear-btn" id="clearHistory" style="margin-bottom: 1rem; width: 100%;">Clear History</button>
                        <div id="historyList"></div>
                    </div>
                    
                    <div class="card" id="facetsCard" style="display:none;">
                        <h2>Field Facets</h2>
                        <div id="facetsList"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Examples Page -->
        <div id="examples" class="page">
            <div class="card">
                <h2>Query Examples</h2>
                <p style="margin-bottom: 1rem; color: #666;">Click on any example to try it in the search box.</p>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">Basic Queries</h3>
                <div class="example-query" data-query="ERROR">
                    <div class="example-query-text">ERROR</div>
                    <div class="example-description">Search for "ERROR" in any field</div>
                </div>
                <div class="example-query" data-query="level:ERROR">
                    <div class="example-query-text">level:ERROR</div>
                    <div class="example-description">Search for ERROR in the level field</div>
                </div>
                <div class="example-query" data-query="user:admin">
                    <div class="example-query-text">user:admin</div>
                    <div class="example-description">Search for admin user</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">Boolean Operators</h3>
                <div class="example-query" data-query="level:ERROR AND user:admin">
                    <div class="example-query-text">level:ERROR AND user:admin</div>
                    <div class="example-description">Both conditions must be true</div>
                </div>
                <div class="example-query" data-query="level:ERROR OR level:WARN">
                    <div class="example-query-text">level:ERROR OR level:WARN</div>
                    <div class="example-description">Either condition must be true</div>
                </div>
                <div class="example-query" data-query="ERROR NOT connection">
                    <div class="example-query-text">ERROR NOT connection</div>
                    <div class="example-description">ERROR but not connection</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">Wildcards</h3>
                <div class="example-query" data-query="user:john*">
                    <div class="example-query-text">user:john*</div>
                    <div class="example-description">Starts with "john"</div>
                </div>
                <div class="example-query" data-query="operation:*Order">
                    <div class="example-query-text">operation:*Order</div>
                    <div class="example-description">Ends with "Order"</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">Range Queries</h3>
                <div class="example-query" data-query="duration:[100 TO 500]">
                    <div class="example-query-text">duration:[100 TO 500]</div>
                    <div class="example-description">Duration between 100 and 500 (text comparison)</div>
                </div>
                <div class="example-query" data-query="status:[500 TO 599]">
                    <div class="example-query-text">status:[500 TO 599]</div>
                    <div class="example-description">HTTP 5xx errors</div>
                </div>
                <div class="example-query" data-query="duration:[400 TO *]">
                    <div class="example-query-text">duration:[400 TO *]</div>
                    <div class="example-description">Duration 400 or greater</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">Complex Queries</h3>
                <div class="example-query" data-query="(level:ERROR OR level:WARN) AND user:admin">
                    <div class="example-query-text">(level:ERROR OR level:WARN) AND user:admin</div>
                    <div class="example-description">Grouped conditions with AND/OR</div>
                </div>
                <div class="example-query" data-query="level:ERROR AND operation:processOrder AND duration:[100 TO *]">
                    <div class="example-query-text">level:ERROR AND operation:processOrder AND duration:[100 TO *]</div>
                    <div class="example-description">Multiple field constraints</div>
                </div>
                <div class="example-query" data-query='raw_text:"connection timeout"'>
                    <div class="example-query-text">raw_text:"connection timeout"</div>
                    <div class="example-description">Exact phrase search in raw log text</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">Common Use Cases</h3>
                <div class="example-query" data-query="status:slow">
                    <div class="example-query-text">status:slow</div>
                    <div class="example-description">Find slow operations</div>
                </div>
                <div class="example-query" data-query="level:ERROR AND component:database">
                    <div class="example-query-text">level:ERROR AND component:database</div>
                    <div class="example-description">Database errors</div>
                </div>
                <div class="example-query" data-query="method:POST AND status:[400 TO 499]">
                    <div class="example-query-text">method:POST AND status:[400 TO 499]</div>
                    <div class="example-description">Failed POST requests</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">üìä Pipe Commands - Stats</h3>
                <div class="example-query" data-query="level:ERROR | stats count">
                    <div class="example-query-text">level:ERROR | stats count</div>
                    <div class="example-description">Count total errors</div>
                </div>
                <div class="example-query" data-query="level:ERROR | stats count by user">
                    <div class="example-query-text">level:ERROR | stats count by user</div>
                    <div class="example-description">Count errors per user</div>
                </div>
                <div class="example-query" data-query="* | stats count avg(duration) by operation">
                    <div class="example-query-text">* | stats count avg(duration) by operation</div>
                    <div class="example-description">Count and average duration per operation</div>
                </div>
                <div class="example-query" data-query="status:slow | stats min(duration) max(duration) avg(duration) by user">
                    <div class="example-query-text">status:slow | stats min(duration) max(duration) avg(duration) by user</div>
                    <div class="example-description">Duration statistics for slow operations by user</div>
                </div>
                <div class="example-query" data-query="* | stats dc(user) by operation">
                    <div class="example-query-text">* | stats dc(user) by operation</div>
                    <div class="example-description">Count distinct users per operation</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">üìà Pipe Commands - Charts</h3>
                <div class="example-query" data-query="level:ERROR | chart count by user">
                    <div class="example-query-text">level:ERROR | chart count by user</div>
                    <div class="example-description">Bar chart of errors by user</div>
                </div>
                <div class="example-query" data-query="level:ERROR | chart type=pie count by operation">
                    <div class="example-query-text">level:ERROR | chart type=pie count by operation</div>
                    <div class="example-description">Pie chart of error distribution by operation</div>
                </div>
                <div class="example-query" data-query="status:slow | chart type=bar avg(duration) by operation">
                    <div class="example-query-text">status:slow | chart type=bar avg(duration) by operation</div>
                    <div class="example-description">Bar chart of average duration for slow operations</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">üìâ Pipe Commands - Time Charts</h3>
                <div class="example-query" data-query="* | timechart span=1h count">
                    <div class="example-query-text">* | timechart span=1h count</div>
                    <div class="example-description">Hourly event count over time</div>
                </div>
                <div class="example-query" data-query="level:ERROR | timechart span=5m count">
                    <div class="example-query-text">level:ERROR | timechart span=5m count</div>
                    <div class="example-description">Error count per 5 minutes</div>
                </div>
                <div class="example-query" data-query="level:ERROR | timechart span=30m count by user">
                    <div class="example-query-text">level:ERROR | timechart span=30m count by user</div>
                    <div class="example-description">Error trends per user every 30 minutes</div>
                </div>
                <div class="example-query" data-query="(level:ERROR OR level:WARN) | timechart span=15m count by level">
                    <div class="example-query-text">(level:ERROR OR level:WARN) | timechart span=15m count by level</div>
                    <div class="example-description">Compare ERROR vs WARN trends over time</div>
                </div>
                
                <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: #2c3e50;">üí° Pipe Command Tips</h3>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                    <p style="margin: 0 0 0.5rem 0; font-weight: bold; color: #2c3e50;">Aggregation Functions:</p>
                    <ul style="margin: 0; padding-left: 1.5rem; color: #666;">
                        <li><code>count</code> - Count of results</li>
                        <li><code>sum(field)</code> - Sum of numeric values</li>
                        <li><code>avg(field)</code> - Average of numeric values</li>
                        <li><code>min(field)</code> - Minimum value</li>
                        <li><code>max(field)</code> - Maximum value</li>
                        <li><code>dc(field)</code> - Distinct count</li>
                    </ul>
                    <p style="margin: 1rem 0 0.5rem 0; font-weight: bold; color: #2c3e50;">Time Spans:</p>
                    <ul style="margin: 0; padding-left: 1.5rem; color: #666;">
                        <li><code>span=Ns</code> - Seconds (e.g., span=30s)</li>
                        <li><code>span=Nm</code> - Minutes (e.g., span=5m)</li>
                        <li><code>span=Nh</code> - Hours (e.g., span=1h)</li>
                        <li><code>span=Nd</code> - Days (e.g., span=1d)</li>
                    </ul>
                    <p style="margin: 1rem 0 0.5rem 0; font-weight: bold; color: #2c3e50;">Chart Types:</p>
                    <ul style="margin: 0; padding-left: 1.5rem; color: #666;">
                        <li><code>type=bar</code> - Bar chart (default)</li>
                        <li><code>type=pie</code> - Pie chart</li>
                        <li><code>type=line</code> - Line chart</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        
        // Page navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = e.target.dataset.page;
                
                // Update active nav
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                e.target.classList.add('active');
                
                // Show page
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(page).classList.add('active');
            });
        });
        
        // Example queries
        document.querySelectorAll('.example-query').forEach(ex => {
            ex.addEventListener('click', () => {
                const query = ex.dataset.query;
                document.getElementById('query').value = query;
                
                // Switch to search page
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelector('[data-page="search"]').classList.add('active');
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('search').classList.add('active');
                
                document.getElementById('query').focus();
            });
        });
        
        // Search history
        function addToHistory(query, indices) {
            const entry = {
                query,
                indices,
                timestamp: new Date().toISOString()
            };
            
            searchHistory.unshift(entry);
            if (searchHistory.length > 10) {
                searchHistory = searchHistory.slice(0, 10);
            }
            
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            renderHistory();
        }
        
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            
            if (searchHistory.length === 0) {
                historyList.innerHTML = '<div style="color: #999; font-size: 0.875rem;">No search history</div>';
                return;
            }
            
            historyList.innerHTML = searchHistory.map(entry => `
                <div class="history-item" data-query="${entry.query}" data-indices="${entry.indices}">
                    <div class="history-query">${entry.query}</div>
                    <div class="history-time">${new Date(entry.timestamp).toLocaleString()}</div>
                </div>
            `).join('');
            
            // Add click handlers
            document.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.getElementById('query').value = item.dataset.query;
                    document.getElementById('indices').value = item.dataset.indices;
                });
            });
        }
        
        document.getElementById('clearHistory').addEventListener('click', () => {
            searchHistory = [];
            localStorage.removeItem('searchHistory');
            renderHistory();
        });
        
        // Clear button
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('query').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('message').innerHTML = '';
            document.getElementById('resultsCard').style.display = 'none';
            document.getElementById('facetsCard').style.display = 'none';
        });
        
        // Add field constraint to query
        function addConstraint(field, value) {
            const queryInput = document.getElementById('query');
            let currentQuery = queryInput.value.trim();
            
            const constraint = `${field}:${value}`;
            
            if (currentQuery === '') {
                queryInput.value = constraint;
            } else {
                queryInput.value = `${currentQuery} AND ${constraint}`;
            }
            
            queryInput.focus();
        }
        
        // Calculate facets from results
        function calculateFacets(results) {
            const facets = {};
            
            results.forEach(result => {
                if (result.fields) {
                    Object.entries(result.fields).forEach(([key, value]) => {
                        if (!facets[key]) {
                            facets[key] = {};
                        }
                        if (!facets[key][value]) {
                            facets[key][value] = 0;
                        }
                        facets[key][value]++;
                    });
                }
            });
            
            return facets;
        }
        
        function renderFacets(facets) {
            const facetsCard = document.getElementById('facetsCard');
            const facetsList = document.getElementById('facetsList');
            
            if (!facets || Object.keys(facets).length === 0) {
                facetsCard.style.display = 'none';
                return;
            }
            
            facetsCard.style.display = 'block';
            
            const MAX_SHOW = 10;
            let html = '';
            
            Object.keys(facets).forEach(field => {
                const values = facets[field];
                const allEntries = Object.entries(values).sort((a, b) => b[1] - a[1]);
                const totalCount = Object.values(values).reduce((a,b) => a+b, 0);
                
                // Show top N values
                const topValues = allEntries.slice(0, MAX_SHOW);
                const remainingValues = allEntries.slice(MAX_SHOW);
                
                html += `<h3 style="margin-top: 1rem; margin-bottom: 0.5rem; font-size: 1rem; color: #2c3e50;">${field} (${totalCount} total)</h3>`;
                html += '<ul class="facet-list">';
                
                topValues.forEach(([value, count]) => {
                    html += `
                        <li class="facet-item" data-field="${field}" data-value="${value}">
                            <span>${value}</span>
                            <span class="facet-count">${count}</span>
                        </li>
                    `;
                });
                
                // Add "Other" category if there are more values
                if (remainingValues.length > 0) {
                    const otherCount = remainingValues.reduce((sum, [_, count]) => sum + count, 0);
                    html += `
                        <li class="facet-item" style="opacity: 0.7; font-style: italic;" title="${remainingValues.length} other values">
                            <span>Other (${remainingValues.length} values)</span>
                            <span class="facet-count">${otherCount}</span>
                        </li>
                    `;
                }
                
                html += '</ul>';
            });
            
            facetsList.innerHTML = html;
            
            // Add click handlers (only for non-Other items)
            document.querySelectorAll('.facet-item[data-field]').forEach(item => {
                item.addEventListener('click', () => {
                    addConstraint(item.dataset.field, item.dataset.value);
                });
            });
        }
        
        // Render functions for pipe results
        function renderTable(tableResult) {
            const resultsEl = document.getElementById('results');
            document.getElementById('pagination').style.display = 'none';
            
            let html = '<table class="results-table">';
            html += '<thead><tr>';
            tableResult.columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            tableResult.rows.forEach(row => {
                html += '<tr>';
                tableResult.columns.forEach(col => {
                    const val = row[col];
                    html += `<td>${val !== null && val !== undefined ? val : ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            
            resultsEl.innerHTML = html;
        }
        
        function renderChart(chartResult) {
            const resultsEl = document.getElementById('results');
            document.getElementById('pagination').style.display = 'none';
            
            // Destroy existing chart if any
            if (window.myChart) {
                window.myChart.destroy();
            }
            
            resultsEl.innerHTML = '<canvas id="resultChart"></canvas>';
            const canvas = document.getElementById('resultChart');
            
            const datasets = [];
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#16a085'];
            const isPieChart = chartResult.chartType === 'pie' || chartResult.chartType === 'doughnut';
            
            for (const [seriesName, values] of Object.entries(chartResult.series)) {
                // For pie charts, each data point needs its own color
                if (isPieChart) {
                    const backgroundColors = values.map((_, idx) => colors[idx % colors.length]);
                    datasets.push({
                        label: seriesName,
                        data: values,
                        backgroundColor: backgroundColors,
                        borderColor: '#fff',
                        borderWidth: 2
                    });
                } else {
                    // For bar/line charts, use one color per series
                    datasets.push({
                        label: seriesName,
                        data: values,
                        backgroundColor: colors[datasets.length % colors.length],
                        borderColor: colors[datasets.length % colors.length],
                        borderWidth: 1
                    });
                }
            }
            
            window.myChart = new Chart(canvas, {
                type: chartResult.chartType || 'bar',
                data: {
                    labels: chartResult.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: isPieChart || datasets.length > 1
                        }
                    },
                    scales: !isPieChart ? {
                        y: {
                            beginAtZero: true
                        }
                    } : {}
                }
            });
        }
        
        function renderTimeChart(timeChartResult) {
            const resultsEl = document.getElementById('results');
            document.getElementById('pagination').style.display = 'none';
            
            // Destroy existing chart if any
            if (window.myChart) {
                window.myChart.destroy();
            }
            
            resultsEl.innerHTML = '<canvas id="resultChart"></canvas>';
            const canvas = document.getElementById('resultChart');
            
            const datasets = [];
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            let colorIndex = 0;
            
            for (const [seriesName, values] of Object.entries(timeChartResult.series)) {
                datasets.push({
                    label: seriesName,
                    data: values,
                    borderColor: colors[colorIndex % colors.length],
                    backgroundColor: colors[colorIndex % colors.length] + '33',
                    fill: false,
                    tension: 0.1
                });
                colorIndex++;
            }
            
            window.myChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: timeChartResult.timestamps,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Search state
        let currentPage = 0;
        let lastSearchParams = null;
        
        // Perform search
        async function performSearch(page = 0) {
            const indices = document.getElementById('indices').value.split(',').map(s => s.trim()).filter(s => s);
            let query = document.getElementById('query').value.trim();
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const sortField = document.getElementById('sortField').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            const messageEl = document.getElementById('message');
            const resultsEl = document.getElementById('results');
            const resultsCard = document.getElementById('resultsCard');
            
            if (page === 0) {
                messageEl.innerHTML = '';
                resultsEl.innerHTML = '';
                resultsCard.style.display = 'none';
                document.getElementById('facetsCard').style.display = 'none';
                document.getElementById('pagination').style.display = 'none';
            }
            
            if (!query) {
                messageEl.innerHTML = '<div class="error">Please enter a search query</div>';
                return;
            }
            
            if (indices.length === 0) {
                messageEl.innerHTML = '<div class="error">Please enter at least one index</div>';
                return;
            }
            
            // Add date range to query if specified
            if (dateFrom || dateTo) {
                const from = dateFrom || '*';
                const to = dateTo || '*';
                const dateQuery = `timestamp:[${from} TO ${to}]`;
                query = query ? `(${query}) AND ${dateQuery}` : dateQuery;
            }
            
            // Save search params
            lastSearchParams = { indices, query, sortField, sortOrder };
            currentPage = page;
            
            messageEl.innerHTML = '<div class="loading">Searching...</div>';
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        indices: indices,
                        query: query,
                        page: page,
                        pageSize: 50,
                        sortField: sortField,
                        sortDescending: sortOrder === 'desc',
                        includeFacets: true
                    })
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || 'Search failed');
                }
                
                const data = await response.json();
                
                if (page === 0) {
                    addToHistory(document.getElementById('query').value, indices.join(', '));
                }
                
                resultsCard.style.display = 'block';
                
                // Check result type and render accordingly
                if (data.resultType === 'TABLE') {
                    messageEl.innerHTML = `<div class="success">Table result</div>`;
                    document.getElementById('totalHits').textContent = 'Table';
                    renderTable(data.pipeResult);
                } else if (data.resultType === 'CHART') {
                    messageEl.innerHTML = `<div class="success">Chart result</div>`;
                    document.getElementById('totalHits').textContent = 'Chart';
                    renderChart(data.pipeResult);
                } else if (data.resultType === 'TIMECHART') {
                    messageEl.innerHTML = `<div class="success">Time chart result</div>`;
                    document.getElementById('totalHits').textContent = 'Time Chart';
                    renderTimeChart(data.pipeResult);
                } else if (data.results && data.results.length > 0) {
                    // Regular log results
                    messageEl.innerHTML = `<div class="success">Found ${data.totalHits} results</div>`;
                    document.getElementById('totalHits').textContent = data.totalHits;
                    
                    // Render facets from server
                    if (data.facets) {
                        renderFacets(data.facets);
                    }
                    
                    // Render results
                    resultsEl.innerHTML = '';
                    data.results.forEach(result => {
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'result-item';
                        
                        const timestamp = result.timestamp ? new Date(result.timestamp).toLocaleString() : 'N/A';
                        
                        let fieldsHtml = '';
                        if (result.fields && Object.keys(result.fields).length > 0) {
                            fieldsHtml = '<div class="result-fields">';
                            for (const [key, value] of Object.entries(result.fields)) {
                                fieldsHtml += `<span class="field-tag" data-field="${key}" data-value="${value}" title="Click to add ${key}:${value} to query">${key}=${value}</span>`;
                            }
                            fieldsHtml += '</div>';
                        }
                        
                        resultDiv.innerHTML = `
                            <div class="result-meta">
                                <strong>Time:</strong> ${timestamp} | 
                                <strong>Index:</strong> ${result.indexName} | 
                                <strong>Score:</strong> ${result.score.toFixed(2)}
                            </div>
                            <div class="result-text">${result.rawText}</div>
                            ${fieldsHtml}
                        `;
                        
                        resultsEl.appendChild(resultDiv);
                    });
                    
                    // Add click handlers to field tags
                    document.querySelectorAll('.field-tag').forEach(tag => {
                        tag.addEventListener('click', () => {
                            addConstraint(tag.dataset.field, tag.dataset.value);
                        });
                    });
                    
                    // Update pagination
                    if (data.totalPages > 1) {
                        document.getElementById('pagination').style.display = 'flex';
                        document.getElementById('currentPage').textContent = data.page + 1;
                        document.getElementById('totalPages').textContent = data.totalPages;
                        document.getElementById('prevPage').disabled = data.page === 0;
                        document.getElementById('nextPage').disabled = data.page >= data.totalPages - 1;
                    } else {
                        document.getElementById('pagination').style.display = 'none';
                    }
                } else {
                    messageEl.innerHTML = '<div class="success">No results found</div>';
                }
                
            } catch (error) {
                messageEl.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        // Search form
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            performSearch(0);
        });
        
        // Pagination handlers
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 0) {
                performSearch(currentPage - 1);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
        
        document.getElementById('nextPage').addEventListener('click', () => {
            performSearch(currentPage + 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        // Sort change handlers
        document.getElementById('sortField').addEventListener('change', () => {
            if (lastSearchParams) {
                performSearch(0);
            }
        });
        
        document.getElementById('sortOrder').addEventListener('change', () => {
            if (lastSearchParams) {
                performSearch(0);
            }
        });
        
        // Initialize
        renderHistory();
        
        // Set random example as placeholder
        window.addEventListener('load', () => {
            const examples = [
                'level:ERROR',
                'status:slow',
                'user:admin',
                '(level:ERROR OR level:WARN) AND user:admin'
            ];
            
            document.getElementById('query').placeholder = examples[Math.floor(Math.random() * examples.length)];
        });
    </script>
</body>
</html>
